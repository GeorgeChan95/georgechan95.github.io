<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>011-Kubernetes Ingress-Nginx | George&#39;s Blog</title>
  <meta name="google-site-verification" content="RobLWkyyFziZxPJ4I887QROdX8XrYthcJwWTcuH0wwQ" />
  <meta name="msvalidate.01" content="626D541C48E5D151F52CECC2C6714BD4" />
  <meta name="360-site-verification" content="c838adf8357ca2f614d08ad5235a1717" />
  <meta name="keywords" content=" linux , Docker , Rocky ">
  <meta name="description" content="011-Kubernetes Ingress-Nginx | George&#39;s Blog">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="集群环境 使用 kubeadmin 安装，Etcd 为单节点    IP Hostname 用途    10.20.1.139 k8s-master01 Master节点   10.20.1.140 k8s-node01 Node节点   10.20.1.141 k8s-node02 Node节点   10.20.1.142 k8s-node03 Node节点   一、ETCD简介ETCD用于共享">
<meta property="og:type" content="article">
<meta property="og:title" content="024-K8S-Etcd的备份与恢复">
<meta property="og:url" content="https://georgechan95.github.io/blog/7a3c8be2.html">
<meta property="og:site_name" content="George&#39;s Blog">
<meta property="og:description" content="集群环境 使用 kubeadmin 安装，Etcd 为单节点    IP Hostname 用途    10.20.1.139 k8s-master01 Master节点   10.20.1.140 k8s-node01 Node节点   10.20.1.141 k8s-node02 Node节点   10.20.1.142 k8s-node03 Node节点   一、ETCD简介ETCD用于共享">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/09/15/20250915-234034.png">
<meta property="og:image" content="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/09/15/20250915-234122.png">
<meta property="og:image" content="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/09/15/20250915-234744.png">
<meta property="og:image" content="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/09/15/20250915-234814.png">
<meta property="og:image" content="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/09/15/20250915-234917.png">
<meta property="og:image" content="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/09/16/20250916-210931.png">
<meta property="article:published_time" content="2025-09-14T09:30:00.000Z">
<meta property="article:modified_time" content="2025-09-17T12:56:38.703Z">
<meta property="article:author" content="George">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="Docker">
<meta property="article:tag" content="Rocky">
<meta property="article:tag" content="Etcd">
<meta property="article:tag" content="Velero">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/09/15/20250915-234034.png">


<link rel="icon" href="/img/favicon.png">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/sublime.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="George's Blog" type="application/atom+xml">
</head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<script src="/js/image-loader.js"></script>
<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/avatar.jpg"/>
</a>
<div class="author">
    <span>George</span>
</div>

<div class="icon">
    
        
            <a title="rss"
               href="/atom.xml"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-rss"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="github"
               href="https://github.com/GeorgeChan95"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-github"></use>
                    </svg>
                
            </a>
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            <a title="email"
               href="mailto:george_95@126.com"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-email"></use>
                    </svg>
                
            </a>
        
    
        
    
        
    
        
    
</div>





<ul>
    <li>
        <div class="all active" data-rel="全部文章">全部文章
            
                <small>(121)</small>
            
        </div>
    </li>
    
        
            
                
    <li>
        <div data-rel="设计模式">
            
            设计模式
            <small>(24)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="算法">
            
            算法
            <small>(5)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="Docker">
            
            Docker
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="Hexo">
            <i class="fold iconfont icon-right"></i>
            Hexo
            <small>(5)</small>
        </div>
        
            <ul class="sub hide">
                
                    
    <li>
        <div data-rel="Hexo&lt;---&gt;Typora">
            
            Typora
            <small>(1)</small>
        </div>
        
    </li>

                
            </ul>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="JUC">
            
            JUC
            <small>(24)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="JVM">
            
            JVM
            <small>(27)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="k8s">
            
            k8s
            <small>(24)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="linux">
            
            linux
            <small>(4)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="neo4j">
            
            neo4j
            <small>(3)</small>
        </div>
        
    </li>

            
        
    
        
            
        
    
        
            
                
    <li>
        <div data-rel="Python">
            <i class="fold iconfont icon-right"></i>
            Python
            <small>(3)</small>
        </div>
        
            <ul class="sub hide">
                
                    
    <li>
        <div data-rel="Python&lt;---&gt;PyCharm">
            
            PyCharm
            <small>(1)</small>
        </div>
        
    </li>

                
            </ul>
        
    </li>

            
        
    
        
            
        
    
        
            
                
    <li>
        <div data-rel="UML">
            
            UML
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
        
            
            
            
    </div>
    <div>
        
            <a class="about  site_url"
               
               href="/about">关于</a>
        
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="121">
<input type="hidden" id="yelog_site_word_count" value="594k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://yelog.org/">叶落阁</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">全部文章</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>插入排序</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>二分法</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>二进制</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>合并有序链表</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>科学上网</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>链表</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>冒泡排序</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>设计模式</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>双亲委派机制</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>算法</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>位运算</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>选择排序</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Docker</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Etcd</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>github</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>github pages</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Harbor</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>hexo</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>java</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>jenkins</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>juc</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>jvm</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>linux</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Loki</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>neo4j</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Pod</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Prometheus</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Python</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Rocky</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>sitemap</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>SpringBoot</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>typora</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ubuntu18</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>UML</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Velero</a>
            </li>
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        
        <a  class="全部文章 k8s "
           href="/blog/7a3c8be2.html"
           data-tag="linux,Docker,Rocky,Etcd,Velero"
           data-author="" >
            <span class="post-title" title="024-K8S-Etcd的备份与恢复">024-K8S-Etcd的备份与恢复</span>
            <span class="post-date" title="2025-09-14 17:30:00">2025/09/14</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/847bacfd.html"
           data-tag="linux,Docker,Rocky"
           data-author="" >
            <span class="post-title" title="023-K8S-Cordon和Drain的使用">023-K8S-Cordon和Drain的使用</span>
            <span class="post-date" title="2025-09-12 20:11:00">2025/09/12</span>
        </a>
        
        
        <a  class="全部文章 Python PyCharm "
           href="/blog/2cd8097a.html"
           data-tag="Python"
           data-author="" >
            <span class="post-title" title="003-PyCharm下载和安装">003-PyCharm下载和安装</span>
            <span class="post-date" title="2025-09-10 12:17:00">2025/09/10</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/6617f273.html"
           data-tag="linux,Docker,Rocky"
           data-author="" >
            <span class="post-title" title="022-K8S-资源限制">022-K8S-资源限制</span>
            <span class="post-date" title="2025-09-09 21:03:00">2025/09/09</span>
        </a>
        
        
        <a  class="全部文章 Python "
           href="/blog/7591dd09.html"
           data-tag="Python"
           data-author="" >
            <span class="post-title" title="002-安装Python开发环境">002-安装Python开发环境</span>
            <span class="post-date" title="2025-09-08 20:22:00">2025/09/08</span>
        </a>
        
        
        <a  class="全部文章 Python "
           href="/blog/95026633.html"
           data-tag="Python"
           data-author="" >
            <span class="post-title" title="001-Python语言概述">001-Python语言概述</span>
            <span class="post-date" title="2025-09-07 10:44:00">2025/09/07</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/e2c03adc.html"
           data-tag="linux,Docker,Rocky"
           data-author="" >
            <span class="post-title" title="021-K8S-安全参数">021-K8S-安全参数</span>
            <span class="post-date" title="2025-08-23 14:43:00">2025/08/23</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/88f4f580.html"
           data-tag="linux,Docker,Rocky"
           data-author="" >
            <span class="post-title" title="020-K8S-审计">020-K8S-审计</span>
            <span class="post-date" title="2025-08-10 14:43:00">2025/08/10</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/9bea6e2e.html"
           data-tag="linux,Docker,Rocky"
           data-author="" >
            <span class="post-title" title="019-K8S-kubectl端口转发">019-K8S-kubectl端口转发</span>
            <span class="post-date" title="2025-08-04 23:02:00">2025/08/04</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/af9812e0.html"
           data-tag="linux,Docker,Rocky"
           data-author="" >
            <span class="post-title" title="018-K8S-临时容器">018-K8S-临时容器</span>
            <span class="post-date" title="2025-08-03 22:01:00">2025/08/03</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/99657768.html"
           data-tag="linux,Docker,Rocky,Pod"
           data-author="" >
            <span class="post-title" title="017-K8S-网络策略NetworkPolicy">017-K8S-网络策略NetworkPolicy</span>
            <span class="post-date" title="2025-07-28 21:33:00">2025/07/28</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/c9536d9e.html"
           data-tag="linux,Docker,Rocky,Pod"
           data-author="" >
            <span class="post-title" title="016-K8S-固定Pod IP地址，基于Calico插件">016-K8S-固定Pod IP地址，基于Calico插件</span>
            <span class="post-date" title="2025-07-26 13:35:00">2025/07/26</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/e62b8338.html"
           data-tag="linux,Docker,Rocky,Prometheus"
           data-author="" >
            <span class="post-title" title="015-K8S-Prometheus部署及监控告警">015-K8S-Prometheus部署及监控告警</span>
            <span class="post-date" title="2025-07-19 16:39:00">2025/07/19</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/f8cf646f.html"
           data-tag="linux,Docker,Rocky,Loki"
           data-author="" >
            <span class="post-title" title="014-K8S-部署Loki+Promtail+Grafana实现日志监控">014-K8S-部署Loki+Promtail+Grafana实现日志监控</span>
            <span class="post-date" title="2025-07-10 21:00:00">2025/07/10</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/3fee6d19.html"
           data-tag="linux,Docker,Rocky,Harbor"
           data-author="" >
            <span class="post-title" title="013-K8S-使用Helm安装Harbor">013-K8S-使用Helm安装Harbor</span>
            <span class="post-date" title="2025-07-07 22:37:00">2025/07/07</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/b42f2c7b.html"
           data-tag="linux,Docker,Rocky"
           data-author="" >
            <span class="post-title" title="012-新建Node节点添加到K8S集群中">012-新建Node节点添加到K8S集群中</span>
            <span class="post-date" title="2025-07-07 20:32:00">2025/07/07</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/6436eaf1.html"
           data-tag="linux,Docker,Rocky"
           data-author="" >
            <span class="post-title" title="011-Kubernetes Ingress-Nginx">011-Kubernetes Ingress-Nginx</span>
            <span class="post-date" title="2025-06-25 19:42:00">2025/06/25</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/d8e3c7b3.html"
           data-tag="linux,Docker,Rocky"
           data-author="" >
            <span class="post-title" title="010-Kubernetes Helm">010-Kubernetes Helm</span>
            <span class="post-date" title="2025-06-21 14:12:00">2025/06/21</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/424f1119.html"
           data-tag="linux,Docker,Rocky"
           data-author="" >
            <span class="post-title" title="009-Kubernetes 集群安全机制">009-Kubernetes 集群安全机制</span>
            <span class="post-date" title="2025-06-14 09:18:00">2025/06/14</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/f2285a2d.html"
           data-tag="linux,Docker,Rocky"
           data-author="" >
            <span class="post-title" title="008-Kubernetes 调度器">008-Kubernetes 调度器</span>
            <span class="post-date" title="2025-06-02 14:40:00">2025/06/02</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/ef156b88.html"
           data-tag="linux,Docker,Rocky"
           data-author="" >
            <span class="post-title" title="007-Kubernetes 存储">007-Kubernetes 存储</span>
            <span class="post-date" title="2025-05-02 10:26:00">2025/05/02</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/970719d6.html"
           data-tag="linux,Docker,Rocky"
           data-author="" >
            <span class="post-title" title="006-Kubernetes Service">006-Kubernetes Service</span>
            <span class="post-date" title="2025-04-28 22:10:00">2025/04/28</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/c790096a.html"
           data-tag="linux,Docker,Rocky"
           data-author="" >
            <span class="post-title" title="005-Kubernetes控制器">005-Kubernetes控制器</span>
            <span class="post-date" title="2025-04-02 20:12:00">2025/04/02</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/79e06aab.html"
           data-tag="linux,Docker,Rocky"
           data-author="" >
            <span class="post-title" title="004-Pod的生命周期">004-Pod的生命周期</span>
            <span class="post-date" title="2025-03-22 09:05:00">2025/03/22</span>
        </a>
        
        
        <a  class="全部文章 Docker "
           href="/blog/b01d5c62.html"
           data-tag="linux,Docker,科学上网"
           data-author="" >
            <span class="post-title" title="Docker配置网络代理实现外网镜像下载">Docker配置网络代理实现外网镜像下载</span>
            <span class="post-date" title="2025-01-08 23:00:00">2025/01/08</span>
        </a>
        
        
        <a  class="全部文章 linux "
           href="/blog/7f174b3e.html"
           data-tag="linux,科学上网,Rocky"
           data-author="" >
            <span class="post-title" title="Rocky9安装Shadowsocks实现科学上网">Rocky9安装Shadowsocks实现科学上网</span>
            <span class="post-date" title="2025-01-08 21:09:00">2025/01/08</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/b00f53e9.html"
           data-tag="linux,Docker,Rocky"
           data-author="" >
            <span class="post-title" title="003-基于Rocky9.3系统使用kubeadm安装k8s1.29集群">003-基于Rocky9.3系统使用kubeadm安装k8s1.29集群</span>
            <span class="post-date" title="2025-01-03 22:05:00">2025/01/03</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/3c79d8d9.html"
           data-tag="linux,Docker,Rocky"
           data-author="" >
            <span class="post-title" title="002-Rocky9.3系统初始化设置和Docker安装">002-Rocky9.3系统初始化设置和Docker安装</span>
            <span class="post-date" title="2025-01-02 13:25:00">2025/01/02</span>
        </a>
        
        
        <a  class="全部文章 k8s "
           href="/blog/7e3a5200.html"
           data-tag="linux,Rocky"
           data-author="" >
            <span class="post-title" title="001-ESXi8安装Rocky9.3虚拟机">001-ESXi8安装Rocky9.3虚拟机</span>
            <span class="post-date" title="2025-01-02 09:34:00">2025/01/02</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/77d85f50.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="25-责任链模式">25-责任链模式</span>
            <span class="post-date" title="2024-12-03 21:08:00">2024/12/03</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/fcec839d.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="24-策略模式">24-策略模式</span>
            <span class="post-date" title="2024-12-02 18:16:00">2024/12/02</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/6109865a.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="23-状态模式">23-状态模式</span>
            <span class="post-date" title="2024-11-29 19:30:00">2024/11/29</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/58d4db7.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="22-解释器模式">22-解释器模式</span>
            <span class="post-date" title="2024-11-28 22:00:00">2024/11/28</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/a5cf7eb4.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="21-备忘录模式">21-备忘录模式</span>
            <span class="post-date" title="2024-11-27 21:40:00">2024/11/27</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/3148d6be.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="20-中介者模式">20-中介者模式</span>
            <span class="post-date" title="2024-11-26 20:35:00">2024/11/26</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/f06aea0b.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="19-观察者模式">19-观察者模式</span>
            <span class="post-date" title="2024-11-25 21:07:00">2024/11/25</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/7dbd9149.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="18-迭代器模式">18-迭代器模式</span>
            <span class="post-date" title="2024-11-24 00:02:00">2024/11/24</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/4fdf6e52.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="17-访问者模式">17-访问者模式</span>
            <span class="post-date" title="2024-11-23 21:55:00">2024/11/23</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/60fd53f.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="16-命令模式">16-命令模式</span>
            <span class="post-date" title="2024-11-23 20:30:00">2024/11/23</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/4930323d.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="15-模板方法模式">15-模板方法模式</span>
            <span class="post-date" title="2024-11-23 19:40:00">2024/11/23</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/e4235185.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="14-代理模式">14-代理模式</span>
            <span class="post-date" title="2024-11-21 23:16:00">2024/11/21</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/1b225c1f.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="13-享元模式">13-享元模式</span>
            <span class="post-date" title="2024-11-20 23:10:00">2024/11/20</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/906e9e8b.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="12-外观模式">12-外观模式</span>
            <span class="post-date" title="2024-11-20 22:09:00">2024/11/20</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/c456a66a.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="11-组合模式">11-组合模式</span>
            <span class="post-date" title="2024-11-16 17:00:00">2024/11/16</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/90213fc6.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="10-装饰器模式">10-装饰器模式</span>
            <span class="post-date" title="2024-11-16 14:06:00">2024/11/16</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/c7419cfa.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="09-桥接模式">09-桥接模式</span>
            <span class="post-date" title="2024-11-14 20:51:00">2024/11/14</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/f77fc055.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="08-适配器模式">08-适配器模式</span>
            <span class="post-date" title="2024-11-12 22:55:00">2024/11/12</span>
        </a>
        
        
        <a  class="全部文章 neo4j "
           href="/blog/a3b0b090.html"
           data-tag="neo4j,SpringBoot"
           data-author="" >
            <span class="post-title" title="Spring Boot对Neo4j节点关系的增删改查">Spring Boot对Neo4j节点关系的增删改查</span>
            <span class="post-date" title="2024-11-12 21:00:30">2024/11/12</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/3ab9aa56.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="07-建造者模式">07-建造者模式</span>
            <span class="post-date" title="2024-11-11 21:55:00">2024/11/11</span>
        </a>
        
        
        <a  class="全部文章 neo4j "
           href="/blog/7dc0fcde.html"
           data-tag="neo4j,SpringBoot"
           data-author="" >
            <span class="post-title" title="Spring Boot整合Neo4j实现增删改查">Spring Boot整合Neo4j实现增删改查</span>
            <span class="post-date" title="2024-11-07 19:04:30">2024/11/07</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/564adc33.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="06-原型模式">06-原型模式</span>
            <span class="post-date" title="2024-11-06 19:00:00">2024/11/06</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/effeea78.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="05-工厂模式">05-工厂模式</span>
            <span class="post-date" title="2024-11-04 21:00:00">2024/11/04</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/d7e99843.html"
           data-tag="设计模式"
           data-author="" >
            <span class="post-title" title="04-单例模式">04-单例模式</span>
            <span class="post-date" title="2024-11-04 19:00:00">2024/11/04</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/90f1850a.html"
           data-tag="设计模式,UML"
           data-author="" >
            <span class="post-title" title="03-UML类图">03-UML类图</span>
            <span class="post-date" title="2024-11-02 14:57:00">2024/11/02</span>
        </a>
        
        
        <a  class="全部文章 UML "
           href="/blog/c13304c1.html"
           data-tag="设计模式,UML"
           data-author="" >
            <span class="post-title" title="02-UML图绘制工具">02-UML图绘制工具</span>
            <span class="post-date" title="2024-11-02 09:57:00">2024/11/02</span>
        </a>
        
        
        <a  class="全部文章 linux "
           href="/blog/2e826df1.html"
           data-tag="linux,ubuntu18"
           data-author="" >
            <span class="post-title" title="Docker环境下RTSP流转RTMP和HLS">Docker环境下RTSP流转RTMP和HLS</span>
            <span class="post-date" title="2024-11-01 15:17:33">2024/11/01</span>
        </a>
        
        
        <a  class="全部文章 设计模式 "
           href="/blog/cd625bba.html"
           data-tag="设计模式,java"
           data-author="" >
            <span class="post-title" title="01-设计模式六大原则">01-设计模式六大原则</span>
            <span class="post-date" title="2024-10-31 17:00:00">2024/10/31</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/1a649f4c.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="13-JUC进阶-ReentrantReadWriteLock与StampedLock">13-JUC进阶-ReentrantReadWriteLock与StampedLock</span>
            <span class="post-date" title="2024-10-19 09:26:00">2024/10/19</span>
        </a>
        
        
        <a  class="全部文章 neo4j "
           href="/blog/5c93903a.html"
           data-tag="linux,neo4j"
           data-author="" >
            <span class="post-title" title="Docker部署Neo4j并导入CSV数据">Docker部署Neo4j并导入CSV数据</span>
            <span class="post-date" title="2024-10-17 15:00:30">2024/10/17</span>
        </a>
        
        
        <a  class="全部文章 linux "
           href="/blog/ad38e6b1.html"
           data-tag="linux,ubuntu18"
           data-author="" >
            <span class="post-title" title="Ubuntu18.04离线源环境搭建">Ubuntu18.04离线源环境搭建</span>
            <span class="post-date" title="2024-10-17 09:47:33">2024/10/17</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/3fdbf0f6.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="12-JUC进阶-从ReentrantLock到AQS源码详解">12-JUC进阶-从ReentrantLock到AQS源码详解</span>
            <span class="post-date" title="2024-10-15 19:42:07">2024/10/15</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/3e0d7592.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="11-JUC进阶-Synchronized与锁升级">11-JUC进阶-Synchronized与锁升级</span>
            <span class="post-date" title="2024-10-06 09:28:00">2024/10/06</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/4502cffa.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="10-JUC进阶-Java对象内存布局和对象头">10-JUC进阶-Java对象内存布局和对象头</span>
            <span class="post-date" title="2024-10-04 09:54:40">2024/10/04</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/4de6a39b.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="09-JUC进阶-ThreadLocal">09-JUC进阶-ThreadLocal</span>
            <span class="post-date" title="2024-10-01 20:39:10">2024/10/01</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/72329cf5.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="08-JUC进阶-常用的原子操作类(18个)">08-JUC进阶-常用的原子操作类(18个)</span>
            <span class="post-date" title="2024-09-28 13:37:09">2024/09/28</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/5e3757c1.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="07-JUC进阶-CAS">07-JUC进阶-CAS</span>
            <span class="post-date" title="2024-09-26 19:37:00">2024/09/26</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/546d628d.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="06-JUC进阶-Volatile与Java内存模型">06-JUC进阶-Volatile与Java内存模型</span>
            <span class="post-date" title="2024-09-25 19:01:01">2024/09/25</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/1f2e0014.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="05-JUC进阶-Java内存模型-JMM">05-JUC进阶-Java内存模型-JMM</span>
            <span class="post-date" title="2024-09-23 23:01:07">2024/09/23</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/19653fb9.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="04-JUC进阶-LockSupport与线程中断">04-JUC进阶-LockSupport与线程中断</span>
            <span class="post-date" title="2024-09-23 20:51:50">2024/09/23</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/219e52ea.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="03-JUC进阶-Java中的锁的解析">03-JUC进阶-Java中的锁的解析</span>
            <span class="post-date" title="2024-09-21 14:15:20">2024/09/21</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/7e2d78eb.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="02-JUC进阶-CompletableFuture">02-JUC进阶-CompletableFuture</span>
            <span class="post-date" title="2024-09-18 22:50:00">2024/09/18</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/3d102971.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="01-JUC进阶-线程基础">01-JUC进阶-线程基础</span>
            <span class="post-date" title="2024-09-18 22:32:00">2024/09/18</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/37d56d14.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="11-CompletableFuture">11-CompletableFuture</span>
            <span class="post-date" title="2024-09-16 16:12:00">2024/09/16</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/31919959.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="10-Fork/Join">10-Fork/Join</span>
            <span class="post-date" title="2024-09-16 13:10:00">2024/09/16</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/a0197c15.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="09-ThreadPool-线程池">09-ThreadPool-线程池</span>
            <span class="post-date" title="2024-09-13 20:10:08">2024/09/13</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/a6760d1f.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="08-阻塞队列BlockingQueue">08-阻塞队列BlockingQueue</span>
            <span class="post-date" title="2024-09-07 17:30:00">2024/09/07</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/838e7581.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="07-JUC辅助类CountDownLatch、CyclicBarrier、Semaphore">07-JUC辅助类CountDownLatch、CyclicBarrier、Semaphore</span>
            <span class="post-date" title="2024-09-07 13:00:00">2024/09/07</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/f60e37c5.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="06-Callable &amp; Future 接口">06-Callable &amp; Future 接口</span>
            <span class="post-date" title="2024-09-06 22:10:00">2024/09/06</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/f184587f.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="05-公平锁和非公平锁，死锁，可重入锁">05-公平锁和非公平锁，死锁，可重入锁</span>
            <span class="post-date" title="2024-09-05 20:12:00">2024/09/05</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/9a09d992.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="04-集合的线程安全">04-集合的线程安全</span>
            <span class="post-date" title="2024-09-04 21:09:05">2024/09/04</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/bd2134da.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="03-线程间通信">03-线程间通信</span>
            <span class="post-date" title="2024-09-04 20:06:00">2024/09/04</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/850dac3c.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="02-Lock接口">02-Lock接口</span>
            <span class="post-date" title="2024-08-30 19:27:00">2024/08/30</span>
        </a>
        
        
        <a  class="全部文章 JUC "
           href="/blog/4e6bd685.html"
           data-tag="java,juc"
           data-author="" >
            <span class="post-title" title="01-多线程的基本概念">01-多线程的基本概念</span>
            <span class="post-date" title="2024-08-30 19:03:01">2024/08/30</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/1b0522f4.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第二十五章-分析GC日志">第二十五章-分析GC日志</span>
            <span class="post-date" title="2024-08-28 21:36:08">2024/08/28</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/944806143.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第二十四章-JVM运行时参数">第二十四章-JVM运行时参数</span>
            <span class="post-date" title="2024-08-27 18:30:10">2024/08/27</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/490498600.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第二十三章-使用OQL语言查询对象信息">第二十三章-使用OQL语言查询对象信息</span>
            <span class="post-date" title="2024-08-24 15:02:10">2024/08/24</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/1471620196.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第二十三章-浅堆-深堆-内存泄漏">第二十三章-浅堆-深堆-内存泄漏</span>
            <span class="post-date" title="2024-08-24 13:04:37">2024/08/24</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/971417975.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第二十三章-JVM监控及诊断工具-GUI篇">第二十三章-JVM监控及诊断工具-GUI篇</span>
            <span class="post-date" title="2024-08-16 21:00:00">2024/08/16</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/2165702380.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第二十二章-JVM监控及诊断工具-命令行篇">第二十二章-JVM监控及诊断工具-命令行篇</span>
            <span class="post-date" title="2024-08-12 19:36:32">2024/08/12</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/2681163762.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第二十一章-性能监控与调优概述">第二十一章-性能监控与调优概述</span>
            <span class="post-date" title="2024-08-12 19:13:06">2024/08/12</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/3537043756.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第二十章-再谈类的加载器">第二十章-再谈类的加载器</span>
            <span class="post-date" title="2024-08-10 13:43:10">2024/08/10</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/3387211378.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第十九章-类的加载过程详解">第十九章-类的加载过程详解</span>
            <span class="post-date" title="2024-08-02 19:33:27">2024/08/02</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/1107503247.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第十八章-字节码指令集与解析指令">第十八章-字节码指令集与解析指令</span>
            <span class="post-date" title="2024-08-01 01:40:02">2024/08/01</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/2772873157.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第十七章-使用javap指令解析class文件">第十七章-使用javap指令解析class文件</span>
            <span class="post-date" title="2024-07-22 23:54:00">2024/07/22</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/143162370.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第十六章-Class文件结构">第十六章-Class文件结构</span>
            <span class="post-date" title="2024-07-15 19:54:50">2024/07/15</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/309245330.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第十五章-GC日志分析">第十五章-GC日志分析</span>
            <span class="post-date" title="2024-07-13 08:34:00">2024/07/13</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/1750792302.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第十四章-垃圾收集器">第十四章-垃圾收集器</span>
            <span class="post-date" title="2024-07-10 19:27:00">2024/07/10</span>
        </a>
        
        
        <a  class="全部文章 算法 "
           href="/blog/484946532.html"
           data-tag="算法,合并有序链表"
           data-author="" >
            <span class="post-title" title="合并两个有序链表">合并两个有序链表</span>
            <span class="post-date" title="2024-07-06 09:11:00">2024/07/06</span>
        </a>
        
        
        <a  class="全部文章 算法 "
           href="/blog/2929260443.html"
           data-tag="算法,链表"
           data-author="" >
            <span class="post-title" title="链表反转">链表反转</span>
            <span class="post-date" title="2024-07-05 19:45:45">2024/07/05</span>
        </a>
        
        
        <a  class="全部文章 算法 "
           href="/blog/1403776474.html"
           data-tag="算法,选择排序,冒泡排序,插入排序"
           data-author="" >
            <span class="post-title" title="选择-冒泡-插入排序">选择-冒泡-插入排序</span>
            <span class="post-date" title="2024-07-03 11:02:16">2024/07/03</span>
        </a>
        
        
        <a  class="全部文章 算法 "
           href="/blog/2561891005.html"
           data-tag="算法,二分法"
           data-author="" >
            <span class="post-title" title="二分搜索">二分搜索</span>
            <span class="post-date" title="2024-06-29 10:04:10">2024/06/29</span>
        </a>
        
        
        <a  class="全部文章 算法 "
           href="/blog/2224151177.html"
           data-tag="算法,二进制,位运算"
           data-author="" >
            <span class="post-title" title="二进制和位运算">二进制和位运算</span>
            <span class="post-date" title="2024-06-20 08:04:00">2024/06/20</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/2105268063.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第十三章-垃圾回收相关概念">第十三章-垃圾回收相关概念</span>
            <span class="post-date" title="2024-01-14 14:27:00">2024/01/14</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/364508352.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第十二章-垃圾回收概述和相关算法">第十二章-垃圾回收概述和相关算法</span>
            <span class="post-date" title="2024-01-06 16:28:00">2024/01/06</span>
        </a>
        
        
        <a  class="全部文章 linux "
           href="/blog/2050535563.html"
           data-tag="linux,jenkins"
           data-author="" >
            <span class="post-title" title="Jenkins的安装和搭建自动化部署平台">Jenkins的安装和搭建自动化部署平台</span>
            <span class="post-date" title="2024-01-05 16:00:00">2024/01/05</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/2388209687.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第十一章-StringTable(字符串常量池)">第十一章-StringTable(字符串常量池)</span>
            <span class="post-date" title="2023-12-25 17:27:06">2023/12/25</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/3385856233.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第十章-执行引擎">第十章-执行引擎</span>
            <span class="post-date" title="2023-12-23 20:03:00">2023/12/23</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/4075763684.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第九章-对象的实例化内存布局与访问定位">第九章-对象的实例化内存布局与访问定位</span>
            <span class="post-date" title="2023-12-21 11:50:00">2023/12/21</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/3720767522.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第八章-直接内存">第八章-直接内存</span>
            <span class="post-date" title="2023-12-20 17:03:00">2023/12/20</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/105864584.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第七章-方法区">第七章-方法区</span>
            <span class="post-date" title="2023-12-14 18:24:00">2023/12/14</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/543408063.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第六章-JVM堆">第六章-JVM堆</span>
            <span class="post-date" title="2023-12-02 08:01:00">2023/12/02</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/554039338.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第五章-本地方法接口">第五章-本地方法接口</span>
            <span class="post-date" title="2023-11-30 17:55:00">2023/11/30</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/1123461525.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第四章-虚拟机栈">第四章-虚拟机栈</span>
            <span class="post-date" title="2023-11-28 20:55:00">2023/11/28</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/1626061462.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第三章-运行时数据区">第三章-运行时数据区</span>
            <span class="post-date" title="2023-11-28 19:31:00">2023/11/28</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/222077543.html"
           data-tag="java,jvm,双亲委派机制"
           data-author="" >
            <span class="post-title" title="第二章-JVM类加载子系统">第二章-JVM类加载子系统</span>
            <span class="post-date" title="2023-11-25 14:35:00">2023/11/25</span>
        </a>
        
        
        <a  class="全部文章 JVM "
           href="/blog/1897413233.html"
           data-tag="java,jvm"
           data-author="" >
            <span class="post-title" title="第一章-JVM和Java体系结构">第一章-JVM和Java体系结构</span>
            <span class="post-date" title="2023-11-25 10:00:00">2023/11/25</span>
        </a>
        
        
        <a  class="全部文章 Hexo "
           href="/blog/4179015178.html"
           data-tag="hexo,github pages,sitemap"
           data-author="" >
            <span class="post-title" title="给博客网站添加站点地图-sitemap">给博客网站添加站点地图-sitemap</span>
            <span class="post-date" title="2023-11-21 20:00:00">2023/11/21</span>
        </a>
        
        
        <a  class="全部文章 Hexo Typora "
           href="/blog/877664098.html"
           data-tag="hexo,typora,github"
           data-author="" >
            <span class="post-title" title="Typora设置图片自动上传Github">Typora设置图片自动上传Github</span>
            <span class="post-date" title="2023-11-20 20:30:00">2023/11/20</span>
        </a>
        
        
        <a  class="全部文章 Hexo "
           href="/blog/2016918085.html"
           data-tag="hexo,github pages"
           data-author="" >
            <span class="post-title" title="Hexo博客安装主题">Hexo博客安装主题</span>
            <span class="post-date" title="2023-11-20 00:00:01">2023/11/20</span>
        </a>
        
        
        <a  class="全部文章 Hexo "
           href="/blog/3069199997.html"
           data-tag="hexo,github pages"
           data-author="" >
            <span class="post-title" title="Hexo主题常用配置">Hexo主题常用配置</span>
            <span class="post-date" title="2023-11-20 00:00:01">2023/11/20</span>
        </a>
        
        
        <a  class="全部文章 Hexo "
           href="/blog/3070587776.html"
           data-tag="hexo,github pages"
           data-author="" >
            <span class="post-title" title="基于Hexo和Github Pages搭建个人博客">基于Hexo和Github Pages搭建个人博客</span>
            <span class="post-date" title="2023-11-18 15:40:20">2023/11/18</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-k8s/011-K8S-Ingress-Nginx" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">011-Kubernetes Ingress-Nginx</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="k8s">k8s</a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color1">linux</a>
            
            <a class="color2">Docker</a>
            
            <a class="color1">Rocky</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
            发布时间 : <time class="date" title='最后更新: 2025-07-06 17:01:02'>2025-06-25 19:42</time>
        
    </div>
    <div class="article-meta">
        
        <span>字数:15.2k</span>
        
        
        <span id="busuanzi_container_page_pv">
            阅读 :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
        <span class="top-comment" title="跳转至评论区">
            <a href="#comments">
                评论:<span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </a>
        </span>
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8"><span class="toc-text">一、负载均衡器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%9F%BA%E4%BA%8E-LVS-%E7%9A%84-HTTPS-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">1. 基于 LVS 的 HTTPS 负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%9F%BA%E4%BA%8E-Nginx-%E7%9A%84-HTTPS-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">2. 基于 Nginx 的 HTTPS 负载均衡</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Ingress%E7%AE%80%E4%BB%8B"><span class="toc-text">二、Ingress简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Ingress-%E4%BB%8B%E7%BB%8D"><span class="toc-text">1. Ingress 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Ingress-%E4%B8%8E-Service"><span class="toc-text">2.  Ingress 与 Service</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81-%E5%AE%89%E8%A3%85-Ingress-%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-text">三、 安装 Ingress 控制器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%B8%8B%E8%BD%BD-Ingress-nginx-%E5%AE%89%E8%A3%85%E5%8C%85"><span class="toc-text">1. 下载 Ingress-nginx 安装包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%AF%BC%E5%85%A5-Ingress-nginx-%E9%95%9C%E5%83%8F"><span class="toc-text">2. 导入 Ingress-nginx 镜像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%AE%89%E8%A3%85-Ingress-nginx"><span class="toc-text">3. 安装 Ingress-nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E8%A7%A3%E5%8E%8B-Ingress-nginx-%E5%8E%8B%E7%BC%A9%E5%8C%85"><span class="toc-text">3.1 解压  Ingress-nginx 压缩包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E7%BC%96%E8%BE%91-values-yaml"><span class="toc-text">3.2 编辑 values.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E5%85%B3%E4%BA%8E-dnsPolicy"><span class="toc-text">3.3 关于 dnsPolicy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E5%AE%89%E8%A3%85-ingress-nginx"><span class="toc-text">3.4 安装 ingress-nginx</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%B5%8B%E8%AF%95-Ingress-nginx"><span class="toc-text">4. 测试 Ingress-nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%88%9B%E5%BB%BA-Service-%E5%92%8C-Deployment"><span class="toc-text">4.1 创建 Service 和 Deployment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%88%9B%E5%BB%BA-Ingress"><span class="toc-text">4.2 创建 Ingress</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E4%BF%AE%E6%94%B9%E4%B8%BB%E6%9C%BA-host-%E6%96%87%E4%BB%B6"><span class="toc-text">4.3 修改主机 host 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE%E5%9F%9F%E5%90%8D"><span class="toc-text">4.4 浏览器访问域名</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81Ingress-Nginx-%E4%BD%BF%E7%94%A8"><span class="toc-text">四、Ingress Nginx 使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Ingress-nginx-HTTP-%E4%BB%A3%E7%90%86"><span class="toc-text">1. Ingress-nginx HTTP 代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Ingress-nginx-HTTPS-%E4%BB%A3%E7%90%86"><span class="toc-text">2. Ingress-nginx HTTPS 代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6%E5%92%8C%E7%A7%81%E9%92%A5"><span class="toc-text">2.1 生成证书和私钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%88%9B%E5%BB%BA%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95"><span class="toc-text">2.2 创建资源清单</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Ingress-nginx-BasicAuth-%E4%BB%A3%E7%90%86"><span class="toc-text">3. Ingress-nginx BasicAuth 代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Ingress-nginx-%E5%9F%9F%E5%90%8D%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-text">4. Ingress-nginx 域名重定向</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Ingress-nginx-Rewrite"><span class="toc-text">5. Ingress-nginx  Rewrite</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E6%A1%88%E4%BE%8B"><span class="toc-text">5.1 案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-rewrite-%E5%92%8C-redirect"><span class="toc-text">5.1 rewrite 和 redirect</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Ingress-nginx-%E9%94%99%E8%AF%AF%E4%BB%A3%E7%A0%81%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-text">6. Ingress-nginx 错误代码重定向</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E9%BB%98%E8%AE%A4%E9%94%99%E8%AF%AF%E5%90%8E%E7%AB%AF%EF%BC%88%E5%85%A8%E5%B1%80%EF%BC%89"><span class="toc-text">6.1 默认错误后端（全局）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-1-%E4%BF%AE%E6%94%B9-values-yaml"><span class="toc-text">6.1.1 修改 values.yaml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-2-%E6%9B%B4%E6%96%B0-Ingress-Nginx"><span class="toc-text">6.1.2 更新 Ingress Nginx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1-3-%E6%B5%8B%E8%AF%95%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95"><span class="toc-text">6.1.3 测试资源清单</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%8D%95%E7%8B%AC%E5%A3%B0%E6%98%8E%E9%94%99%E8%AF%AF%E5%90%8E%E7%AB%AF"><span class="toc-text">6.2 单独声明错误后端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Ingress-nginx-%E5%8C%B9%E9%85%8D%E8%AF%B7%E6%B1%82%E5%A4%B4"><span class="toc-text">7. Ingress-nginx  匹配请求头</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E5%BC%80%E5%90%AF-Snippet"><span class="toc-text">7.1 开启 Snippet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E7%BC%96%E8%BE%91%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95"><span class="toc-text">7.2 编辑资源清单</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Ingress-nginx-%E9%85%8D%E7%BD%AE%E9%BB%91%E7%99%BD%E5%90%8D%E5%8D%95"><span class="toc-text">8. Ingress-nginx  配置黑白名单</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88"><span class="toc-text">8.1. 配置方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E9%BB%91%E7%99%BD%E5%90%8D%E5%8D%95%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">8.2 黑白名单的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-ConfigMap-%E6%B7%BB%E5%8A%A0%E9%BB%91%E5%90%8D%E5%8D%95"><span class="toc-text">8.3 ConfigMap 添加黑名单</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-3-1-%E7%BC%96%E8%BE%91-Ingress-Nginx-ConfigMap"><span class="toc-text">8.3.1 编辑 Ingress-Nginx ConfigMap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-3-2-%E6%B5%8B%E8%AF%95%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95"><span class="toc-text">8.3.2 测试资源清单</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-Annotations-%E6%B7%BB%E5%8A%A0%E9%BB%91%E5%90%8D%E5%8D%95"><span class="toc-text">8.4 Annotations 添加黑名单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-ConfigMap-%E8%AE%BE%E7%BD%AE%E7%99%BD%E5%90%8D%E5%8D%95"><span class="toc-text">8.5 ConfigMap 设置白名单</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-5-1-%E7%BC%96%E8%BE%91-Ingress-Nginx-ConfigMap"><span class="toc-text">8.5.1 编辑 Ingress-Nginx ConfigMap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-5-2-%E6%B5%8B%E8%AF%95%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95"><span class="toc-text">8.5.2 测试资源清单</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-6-Annotations-%E6%B7%BB%E5%8A%A0%E7%99%BD%E5%90%8D%E5%8D%95"><span class="toc-text">8.6 Annotations 添加白名单</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-Ingress-nginx-%E9%80%9F%E7%8E%87%E9%99%90%E5%88%B6"><span class="toc-text">9. Ingress-nginx  速率限制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-%E9%80%9F%E7%8E%87%E9%99%90%E5%88%B6%E8%AE%BE%E7%BD%AE"><span class="toc-text">9.1 速率限制设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-%E6%B5%8B%E8%AF%95%E6%A1%88%E4%BE%8B%EF%BC%9A%E6%97%A0%E9%80%9F%E7%8E%87%E9%99%90%E5%88%B6"><span class="toc-text">9.2 测试案例：无速率限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-%E6%B5%8B%E8%AF%95%E6%A1%88%E4%BE%8B%EF%BC%9A%E4%BD%BF%E7%94%A8-Ingress-%E9%99%90%E5%88%B6%E8%AF%B7%E6%B1%82%E9%80%9F%E7%8E%87"><span class="toc-text">9.3 测试案例：使用 Ingress 限制请求速率</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-Ingress-nginx-%E7%81%B0%E5%BA%A6%E6%88%96%E8%80%85%E9%87%91%E4%B8%9D%E9%9B%80%E5%8F%91%E5%B8%83"><span class="toc-text">10. Ingress-nginx  灰度或者金丝雀发布</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-%E6%A6%82%E8%BF%B0"><span class="toc-text">10.1 概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2-%E5%88%9B%E5%BB%BA-V1-%E7%89%88%E6%9C%AC%E7%9A%84-Ingress"><span class="toc-text">10.2 创建  V1 版本的 Ingress</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-%E5%88%9B%E5%BB%BA-V2-%E7%89%88%E6%9C%AC%E7%9A%84-Ingress"><span class="toc-text">10.3 创建 V2 版本的 Ingress</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-Ingress-nginx-%E4%BB%A3%E7%90%86%E5%90%8E%E7%AB%AF-https-%E5%8D%8F%E8%AE%AE"><span class="toc-text">11. Ingress-nginx  代理后端 https 协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-Ingress-nginx-%E5%9B%9B%E5%B1%82%E4%BB%A3%E7%90%86"><span class="toc-text">12. Ingress-nginx  四层代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#12-1TCP%E4%BB%A3%E7%90%86"><span class="toc-text">12.1TCP代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-2-UDP%E4%BB%A3%E7%90%86"><span class="toc-text">12.2 UDP代理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-Ingress-nginx-%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA"><span class="toc-text">13. Ingress-nginx  链路追踪</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#13-1-%E9%83%A8%E7%BD%B2-Jaeger"><span class="toc-text">13.1 部署 Jaeger</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-ingress-%E8%AE%BE%E7%BD%AE"><span class="toc-text">13.2 ingress 设置</span></a></li></ol></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>K8S集群服务器</strong></p>
<table>
<thead>
<tr>
<th>IP</th>
<th>Hostname</th>
</tr>
</thead>
<tbody><tr>
<td>10.20.1.139</td>
<td>k8s-master01</td>
</tr>
<tr>
<td>10.20.1.140</td>
<td>k8s-node01</td>
</tr>
<tr>
<td>10.20.1.141</td>
<td>k8s-node02</td>
</tr>
</tbody></table>
<h1 id="一、负载均衡器"><a href="#一、负载均衡器" class="headerlink" title="一、负载均衡器"></a>一、负载均衡器</h1><p>负载均衡器有两类，区别在于 <strong>四层网络</strong> 和 <strong>七层网络</strong> 的支持，传输层在第四层，这层协议有 TCP&#x2F;UDP&#x2F;TCP SSL 等，而七层有 HTTP&#x2F;HTTPS。</p>
<h2 id="1-基于-LVS-的-HTTPS-负载均衡"><a href="#1-基于-LVS-的-HTTPS-负载均衡" class="headerlink" title="1. 基于 LVS 的 HTTPS 负载均衡"></a>1. 基于 LVS 的 HTTPS 负载均衡</h2><p>基于 LVS 的 HTTPS 负载均衡 是 典型的四层代理架构。客户端发出请求，经过LVS直接转发到服务器，然后服务器返回结果，从请求的发出到结果的响应，中间仅仅产生一次完整的TCP连接。</p>
<p><img src="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/06/26/20250626-194737.png" alt="四层代理架构"></p>
<h2 id="2-基于-Nginx-的-HTTPS-负载均衡"><a href="#2-基于-Nginx-的-HTTPS-负载均衡" class="headerlink" title="2. 基于 Nginx 的 HTTPS 负载均衡"></a>2. 基于 Nginx 的 HTTPS 负载均衡</h2><p>基于 Nginx 的 HTTPS 负载均衡是一种基于七层网络代理架构的实现。客户端发出 https 请求，请求到达nginx服务器，nginx 重新生成一个新的 http 请求发到真实的服务器，服务器计算结果后发往 nginx，nginx再将结果以 https 的方式返回给客户端。从请求的发出到结果的响应，中间产生了两次请求。</p>
<p><img src="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/06/26/20250626-195032.png" alt="七层代理架构"></p>
<h1 id="二、Ingress简介"><a href="#二、Ingress简介" class="headerlink" title="二、Ingress简介"></a>二、Ingress简介</h1><h2 id="1-Ingress-介绍"><a href="#1-Ingress-介绍" class="headerlink" title="1. Ingress 介绍"></a>1. Ingress 介绍</h2><p>Ingress 是从 Kubernetes 集群外部访问集群内部服务的入口，同时为集群内的 Service 提供七层负载均衡能力。它提供了 HTTP 和 HTTPS 路由功能，使外部流量能够访问集群内部的服务。通过定义 Ingress 资源，可以控制哪些外部请求能够访问集群中的哪些服务，以及如何路由这些请求。</p>
<p>具体架构图如下：</p>
<p><img src="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/06/26/20250626-193516" alt="Ingress架构"></p>
<p>我们做网站时，使用 Nginx 做 Web 服务器，会使用一个子域名绑定一个网站，<code>a.xxx.com</code> 绑定 A 网站，<code>b.xxx.com</code> 绑定 B 网站，这样在一个域名的不同子域名可以访问不同的站点，对于现在的大多数互联网网站，依然会使用这种方法划分。</p>
<p>在微服务架构中，多个模块部署在不同的服务器上，则但是我们希望都通过 <code>xxx.com</code> 这个域名直接访问，就好像所有模块都在一起，让用户感觉只有一个网站。则可能会使用目录路径对模块进行划分，例如如果我们要实现 <code>xxx.com/a</code> 访问 A 模块，<code>xxx.com/b</code> 访问 B 模块，但对用户来说，一直在访问 <code>xxx.com</code> 这个域名。</p>
<p>这种需求，我们可以使用 nginx 进行反向代理，而在 Kubernetes 中，这种需求也是一模一样的。</p>
<p>首先，我们可以为 A、B、C 等应用，创建多个 Service，每个 Service 访问一个应用，然后使用 Ingress 配置路由规则，决定 URL 可以访问哪个 Service。</p>
<p><img src="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/06/26/20250626-200950.png" alt="Ingress代理请求"></p>
<blockquote>
<p>Ingress 公开了从集群外部到集群内服务的 HTTP 和 HTTPS 路由，Ingress 资源上定义的规则控制了路由。</p>
</blockquote>
<p>Ingress 可以让集群中的多个 Service 能够从集群外访问，Ingress 还提供负载均衡、SSL&#x2F;TLS 和基于名称的虚拟服务器等，Ingress 可以配置边缘路由器或其他前端工具来帮助处理网络流量，但是一般都是通自己的负载均衡器来实现。</p>
<p>Ingress 有两部分，一部分是 LoadBalancer ，提供统一入口，代理请求；另一部分是 Ingress 控制器，复制定义路由规则等。</p>
<p>如果不使用公有云平台的 LoadBalancer ，那么就自己搭建一个服务器，这台服务器加入到 Kubernetes 集群中，做流量入口，这台服务器网络接口必须够大，抗得住流量。</p>
<h2 id="2-Ingress-与-Service"><a href="#2-Ingress-与-Service" class="headerlink" title="2.  Ingress 与 Service"></a>2.  Ingress 与 Service</h2><p>在前面，我们已经学习到了 Service，通过 Service 我们可以暴露一个端口到外网中，通过这个端口可以访问应用。</p>
<p>其中，有两种方法可以暴露 Service，可以让其被集群外部访问：</p>
<ul>
<li>使用 <code>Service.Type=LoadBalancer</code></li>
<li>使用 <code>Service.Type=NodePort</code></li>
</ul>
<p>Service 的访问方式是 IP，每次要将服务公开给外界时，都必须创建一个新的 LoadBalancer 并向云服务商获取一个公网 IP 地址。或者使用 <code>NodePort</code>，但是只能在一台服务器上被访问，而且 Service 只能为一种 Pod 服务，暴露一个或多个端口，那么 N 个服务，就需要创建 N 个 Service。Service 虽然能够公开端口到外部网络中，但是无法将这些服务合并到一个 <code>example.com/&#123;服务&#125;</code> 中访问，Service 需要通过不同的端口访问。</p>
<p>如果你有一个 <code>example.com</code> 域名，你部署了多个 Web 服务，其中有两个子模块分别为课程(course)、考试(exam) 两个微服务，这些模块构成了一个培训网站。此时我们希望访问 <code>example.com/api/course</code> 能够访问课程学习模块，访问 <code>example.com/api/exam</code> 能够访问考试模块。显然，Service 是无法做到的。</p>
<p>使用 Ingress ，可以轻松设置路由规则，而且无需创建一堆 LoadBalancers&#x2F;Nodes 公开每个服务，并且 Ingress 本身具有很多功能。</p>
<blockquote>
<p>Ingress 也需要 Service 。</p>
</blockquote>
<h1 id="三、-安装-Ingress-控制器"><a href="#三、-安装-Ingress-控制器" class="headerlink" title="三、 安装 Ingress 控制器"></a>三、 安装 Ingress 控制器</h1><p>Ingress 控制器有多种实现，其中 Kubernetes 官方有一个名为 Ingress-nginx 的实现，其它实现还有 Kong Ingress、Traefik、HAProxy Ingress 等。这里演示 使用 Helm 安装 Ingress-nginx 。</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/deploy/#using-helm">https://kubernetes.github.io/ingress-nginx/deploy/#using-helm</a></p>
<h2 id="1-下载-Ingress-nginx-安装包"><a href="#1-下载-Ingress-nginx-安装包" class="headerlink" title="1. 下载 Ingress-nginx 安装包"></a>1. 下载 Ingress-nginx 安装包</h2><p>需要首先安装helm管理工具：<a href="https://georgechan95.github.io/blog/d8e3c7b3.html">https://georgechan95.github.io/blog/d8e3c7b3.html</a></p>
<p>ingress-nginx 的仓库在国外，国内下载需要vpn支持，参考：<a href="https://georgechan95.github.io/blog/7f174b3e.html">https://georgechan95.github.io/blog/7f174b3e.html</a></p>
<pre><code class="highlight bash"><span class="comment"># 添加 ingress-nginx仓库</span>
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx

<span class="comment"># 下载 ingress-nginx 安装包</span>
helm pull ingress-nginx/ingress-nginx --version=4.8.3</code></pre>



<h2 id="2-导入-Ingress-nginx-镜像"><a href="#2-导入-Ingress-nginx-镜像" class="headerlink" title="2. 导入 Ingress-nginx 镜像"></a>2. 导入 Ingress-nginx 镜像</h2><p>这些镜像是 ingress-nginx 启动时所需的镜像，由于国内的网络无法从国外下载镜像，因此需要提前把这些镜像下载好，导入到服务器中。</p>
<p>关于如何使用 Docker 拉取谷歌镜像，参考这篇博客：<a href="https://georgechan95.github.io/blog/b01d5c62.html">https://georgechan95.github.io/blog/b01d5c62.html</a></p>
<pre><code class="highlight bash"><span class="comment"># 下载 ingress-nginx 需要的镜像</span>
<span class="comment"># 所有节点都需要导入这些镜像</span>
docker pull registry.k8s.io/ingress-nginx/controller:v1.9.4
docker pull registry.k8s.io/defaultbackend-amd64:1.5
docker pull registry.k8s.io/ingress-nginx/kube-webhook-certgen:v20231011-8b53cabe0
docker pull registry.k8s.io/ingress-nginx/opentelemetry:v20230721-3e2062ee5</code></pre>



<h2 id="3-安装-Ingress-nginx"><a href="#3-安装-Ingress-nginx" class="headerlink" title="3. 安装 Ingress-nginx"></a>3. 安装 Ingress-nginx</h2><h3 id="3-1-解压-Ingress-nginx-压缩包"><a href="#3-1-解压-Ingress-nginx-压缩包" class="headerlink" title="3.1 解压  Ingress-nginx 压缩包"></a>3.1 解压  Ingress-nginx 压缩包</h3><pre><code class="highlight bash"><span class="comment"># 安装包解压</span>
$ tar -zxvf ingress-nginx-4.8.3.tgz

<span class="comment"># 进入 ingress-nginx 解压后的目录</span>
$ <span class="built_in">cd</span> ingress-nginx

<span class="comment"># 当前所在目录</span>
$ <span class="built_in">pwd</span>
/opt/k8s/10/ingress-nginx

<span class="comment"># 查看 ingress-nginx 目录结构</span>
$ tree .
.
├── CHANGELOG.md
├── Chart.yaml
├── .....
├── README.md.gotmpl
├── changelog
│   ├── Changelog-4.5.2.md
│   ├── .....
│   └── Changelog-4.8.3.md
├── changelog.md.gotmpl
├── ci
│   ├── controller-admission-tls-cert-manager-values.yaml
........
│   └── deployment-webhook-values.yaml
├── templates
│   ├── NOTES.txt
│   ├── admission-webhooks
│   │   ├── cert-manager.yaml
│   │   ├── job-patch
│   │   │   ├── clusterrole.yaml
│   │   │   ├── ......
│   │   │   └── serviceaccount.yaml
│   │   └── validating-webhook.yaml
│   ├── clusterrole.yaml
│   ├── .....
│   └── default-backend-serviceaccount.yaml
└── values.yaml</code></pre>



<h3 id="3-2-编辑-values-yaml"><a href="#3-2-编辑-values-yaml" class="headerlink" title="3.2 编辑 values.yaml"></a>3.2 编辑 values.yaml</h3><pre><code class="highlight yaml"><span class="comment"># 修改 values.yaml 文件</span>
<span class="string">$</span> <span class="string">vim</span> <span class="string">values.yaml</span>

<span class="comment"># 修改1：</span>
<span class="comment"># 修改如下内容：</span>
<span class="string">controller</span>
  <span class="attr">hostNetwork:</span> <span class="literal">true</span> <span class="comment"># 使用主机网路</span>
  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span> <span class="comment"># Pod 的网络命名空间与主机共享，Pod 使用主机的网络栈</span>
  <span class="attr">kind:</span> <span class="string">DaemonSet</span> <span class="comment"># 每个节点部署一个 ingress-nginx-controller</span>
  <span class="attr">ingressClassResource:</span>
    <span class="attr">default:</span> <span class="literal">true</span> <span class="comment"># 使用默认的Inginx类，默认是 nginx</span>

<span class="comment"># 修改2：</span>
<span class="comment">#注释 digest 相关内容</span>
<span class="string">controller</span>
  <span class="attr">image:</span>
    <span class="comment">#digest: sha256:xxxxx</span>
    <span class="comment">#digestChroot: sha256:xxxxx</span>
  <span class="attr">admissionWebhooks:</span>
    <span class="attr">patch:</span>
      <span class="attr">image:</span>
        <span class="comment">#digest: sha256:xxxxx</span></code></pre>

<blockquote>
<p>将解压后的 ingress-nginx 目录内 values.yaml 文件中的 digest: sha256xxxx 所在的所有的行注释掉，避免因为下载镜像的指纹与文件要求不一致，无法运行</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/06/25/20250625-171224.png" alt="注释digest指纹信息"></p>
<h3 id="3-3-关于-dnsPolicy"><a href="#3-3-关于-dnsPolicy" class="headerlink" title="3.3 关于 dnsPolicy"></a>3.3 关于 dnsPolicy</h3><p><strong>ClusterFirstWithHostNet</strong>：</p>
<ul>
<li>当 Pod 的 <code>hostNetwork</code> 设置为 true 时，使用该 DNS 策略。</li>
<li>这意味着 Pod 的网络命名空间与主机共享，Pod 使用主机的网络栈。</li>
<li>在此配置下，Pod 将首先尝试通过主机上的 DNS 解析 DNS 请求。如果主机上没有找到，则会将请求发送到 kube-dns 服务，由 kube-dns 服务进行处理。</li>
<li>这种策略适用于需要与主机网络共享的特殊情况，但它不会为 Pod 提供专用的 DNS 解析功能。</li>
</ul>
<p><strong>ClusterFirst</strong>：</p>
<ul>
<li>这是 Kubernetes 中默认的 DNS 策略。</li>
<li>当 Pod 的 <code>hostNetwork</code> 设置为 false 或未设置时，使用该策略。</li>
<li>在此策略下，Pod 首先尝试通过 kube-dns 服务解析 DNS 请求。如果 kube-dns 无法解析，则会向上级 DNS 服务器继续发起请求。</li>
<li>这种策略适用于大多数情况，其中 Pod 需要使用 Kubernetes 集群的 DNS 服务解析其他 Pod 或服务的主机名。</li>
</ul>
<h3 id="3-4-安装-ingress-nginx"><a href="#3-4-安装-ingress-nginx" class="headerlink" title="3.4 安装 ingress-nginx"></a>3.4 安装 ingress-nginx</h3><pre><code class="highlight bash"><span class="comment"># 使用 Helm 安装 ingress-nginx</span>
$ helm install ingress-nginx --namespace ingress-nginx --create-namespace .

<span class="comment"># 查看 ingress-nginx release</span>
$ helm list -n ingress-nginx
NAME         	NAMESPACE    	REVISION	UPDATED                                	STATUS  	CHART              	APP VERSION
ingress-nginx	ingress-nginx	1       	2025-06-26 18:35:32.209570796 +0800 CST	deployed	ingress-nginx-4.8.3	1.9.4

<span class="comment"># 查看 IngressClass</span>
$ kubectl get ingressclass
NAME    CONTROLLER             PARAMETERS   AGE
nginx   k8s.io/ingress-nginx   &lt;none&gt;       153m

<span class="comment"># 查看 Service</span>
$ kubectl get service -n ingress-nginx
NAME                                 TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
ingress-nginx-controller             LoadBalancer   10.105.7.64     &lt;pending&gt;     80:32570/TCP,443:31991/TCP   117m
ingress-nginx-controller-admission   ClusterIP      10.102.42.201   &lt;none&gt;        443/TCP                      117m

<span class="comment"># 查看 Pod</span>
$ kubectl get pod -n ingress-nginx -o wide
NAME                             READY   STATUS    RESTARTS   AGE    IP              NODE         NOMINATED NODE   READINESS GATES
ingress-nginx-controller-pf6sb   1/1     Running   0          117m   192.168.6.141   k8s-node02   &lt;none&gt;           &lt;none&gt;
ingress-nginx-controller-qmb7h   1/1     Running   0          117m   192.168.6.140   k8s-node01   &lt;none&gt;           &lt;none&gt;

<span class="comment"># 查看 DaemonSet</span>
$ kubectl get daemonset -n ingress-nginx -o wide
NAME                       DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE    CONTAINERS   IMAGES                                            SELECTOR
ingress-nginx-controller   2         2         2       2            2           kubernetes.io/os=linux   118m   controller   registry.k8s.io/ingress-nginx/controller:v1.9.4   app.kubernetes.io/component=controller,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/name=ingress-nginx</code></pre>



<h2 id="4-测试-Ingress-nginx"><a href="#4-测试-Ingress-nginx" class="headerlink" title="4. 测试 Ingress-nginx"></a>4. 测试 Ingress-nginx</h2><h3 id="4-1-创建-Service-和-Deployment"><a href="#4-1-创建-Service-和-Deployment" class="headerlink" title="4.1 创建 Service 和 Deployment"></a>4.1 创建 Service 和 Deployment</h3><p><code>httpproxy-dep-svc.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>
<span class="attr">kind:</span> <span class="string">Deployment</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">nginx-deploy</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">replicas:</span> <span class="number">2</span>
  <span class="attr">selector:</span>
    <span class="attr">matchLabels:</span>
      <span class="attr">app:</span> <span class="string">nginx</span>
  <span class="attr">template:</span>
    <span class="attr">metadata:</span>
      <span class="attr">labels:</span>
        <span class="attr">app:</span> <span class="string">nginx</span>
    <span class="attr">spec:</span>
      <span class="attr">containers:</span>
        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span>
          <span class="attr">image:</span> <span class="string">nginx:1.29.0</span>
          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>
          <span class="attr">ports:</span>
            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span>
              <span class="attr">containerPort:</span> <span class="number">80</span>
              <span class="attr">protocol:</span> <span class="string">TCP</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">Service</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">nginx-svc</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span>
      <span class="attr">targetPort:</span> <span class="number">80</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
  <span class="attr">selector:</span>
    <span class="attr">app:</span> <span class="string">nginx</span></code></pre>

<blockquote>
<p>执行资源清单</p>
</blockquote>
<pre><code class="highlight bash">$ kubectl apply -f httpproxy-dep-svc.yaml</code></pre>

<blockquote>
<p>查看资源</p>
</blockquote>
<pre><code class="highlight bash">$ kubectl get svc -o wide
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR
kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   59d   &lt;none&gt;
nginx-svc    ClusterIP   10.111.16.251   &lt;none&gt;        80/TCP    8s    app=nginx

$ kubectl get deployment -o wide 
NAME           READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR
nginx-deploy   2/2     2            2           16s   my-nginx     nginx:1.29.0   app=nginx

$ kubectl get pods -o wide
NAME                            READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES
nginx-deploy-6fc4ff86dc-n76xc   1/1     Running   0          22s   172.16.58.249   k8s-node02   &lt;none&gt;           &lt;none&gt;
nginx-deploy-6fc4ff86dc-nlmw5   1/1     Running   0          22s   172.16.85.206   k8s-node01   &lt;none&gt;           &lt;none&gt;</code></pre>



<h3 id="4-2-创建-Ingress"><a href="#4-2-创建-Ingress" class="headerlink" title="4.2 创建 Ingress"></a>4.2 创建 Ingress</h3><p><code>ingress.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span> <span class="comment"># 指定 API 版本</span>
<span class="attr">kind:</span> <span class="string">Ingress</span> <span class="comment"># 指定资源类型为 Ingress，表示这是一个用于管理 HTTP/HTTPS 流量的 Kubernetes 资源</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">ingress-httpproxy</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">ingressClassName:</span> <span class="string">nginx</span> <span class="comment"># 指定此 Ingress 资源由名称为 nginx 的 IngressClass 处理，定义在 values.yaml 中 controller.ingressClassResource.name</span>
  <span class="attr">rules:</span> <span class="comment"># 定义了流量路由的规则，即如何根据域名（host）和路径（path）将请求转发到后端服务。</span>
    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.test-http-proxy.com</span> <span class="comment"># 指定此规则适用于请求的 HTTP 主机头（Host Header）为 www.test-http-proxy.com 的流量。客户端必须通过该域名访问, 如果省略 host，Ingress 会匹配所有域名（即通配规则）。</span>
      <span class="attr">http:</span> <span class="comment"># 定义了 HTTP 协议的路由规则</span>
        <span class="attr">paths:</span> <span class="comment"># 用于指定路径匹配规则</span>
          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span> <span class="comment"># 指定匹配的 URL 路径为 /，即根路径,这是最常见的路径，表示匹配所有以 / 开头的请求</span>
            <span class="attr">pathType:</span> <span class="string">Prefix</span> <span class="comment"># 定义路径匹配的类型为 Prefix，表示匹配以指定路径（/) 开头的所有请求</span>
            <span class="attr">backend:</span> <span class="comment"># 定义请求的转发目标，即后端服务</span>
              <span class="attr">service:</span>
                <span class="attr">name:</span> <span class="string">nginx-svc</span> <span class="comment"># 指定后端服务的名称为 nginx-svc.（必须存在于同一命名空间，或通过 &lt;namespace&gt;/&lt;service-name&gt; 跨命名空间引用）</span>
                <span class="attr">port:</span>
                  <span class="attr">number:</span> <span class="number">80</span> <span class="comment"># 指定目标 Service 的端口为 80</span></code></pre>

<blockquote>
<p>执行资源清单</p>
</blockquote>
<pre><code class="highlight bash">$ curl http://www.test-http-proxy.com</code></pre>

<blockquote>
<p>查看资源</p>
</blockquote>
<pre><code class="highlight bash">$ kubectl get ingress -o wide
NAME                CLASS   HOSTS                     ADDRESS   PORTS   AGE
ingress-httpproxy   nginx   www.test-http-proxy.com             80      18</code></pre>





<h3 id="4-3-修改主机-host-文件"><a href="#4-3-修改主机-host-文件" class="headerlink" title="4.3 修改主机 host 文件"></a>4.3 修改主机 host 文件</h3><p>修改host文件，将其中一台集群节点的IP，映射域名：<a target="_blank" rel="noopener" href="http://www.test-http-proxy.com/">www.test-http-proxy.com</a></p>
<pre><code class="highlight bash">$ <span class="built_in">cat</span> /etc/hosts
10.20.1.140 www.test-http-proxy.com</code></pre>

<p><img src="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/07/04/20250704-151113.png" alt="测试Host文件域名映射"></p>
<p>10.20.1.140 是 node节点的Ip，部署了 Ingress 控制器。这里通过 Ingress 控制器 将请求转发到 SVC。</p>
<h3 id="4-4-浏览器访问域名"><a href="#4-4-浏览器访问域名" class="headerlink" title="4.4 浏览器访问域名"></a>4.4 浏览器访问域名</h3><p>打开浏览器，访问 <a target="_blank" rel="noopener" href="http://www.test-http-proxy.com,/">http://www.test-http-proxy.com，</a> 通过访问 Ingress Controller ，访问到 Nginx Svc</p>
<pre><code class="highlight bash">$ kubectl get service -n ingress-nginx
NAME                                 TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
ingress-nginx-controller             LoadBalancer   10.105.7.64     &lt;pending&gt;     80:32570/TCP,443:31991/TCP   117m
ingress-nginx-controller-admission   ClusterIP      10.102.42.201   &lt;none&gt;        443/TCP                      117m</code></pre>

<p><img src="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/07/04/20250704-151605.png" alt="Ingress-Nginx 实现 Http 代理"></p>
<p>至此可以了解到通过使用 Ingress-Nginx 让外部流量能够访问集群内部的服务。</p>
<h1 id="四、Ingress-Nginx-使用"><a href="#四、Ingress-Nginx-使用" class="headerlink" title="四、Ingress Nginx 使用"></a>四、Ingress Nginx 使用</h1><p>ingress的api版本历经过多次变化他们的配置项也不太一样分别是：</p>
<ul>
<li>extensions&#x2F;v1beta1：1.16版本之前使用</li>
<li>networking.k8s.io&#x2F;v1beta1：1.19版本之前使用</li>
<li>networking.k8s.io&#x2F;v1：1.19版本之后使用</li>
</ul>
<h2 id="1-Ingress-nginx-HTTP-代理"><a href="#1-Ingress-nginx-HTTP-代理" class="headerlink" title="1. Ingress-nginx HTTP 代理"></a>1. Ingress-nginx HTTP 代理</h2><p>资源清单：<code>ingress-nginx-http-proxy.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>
<span class="attr">kind:</span> <span class="string">Deployment</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">nginx-deploy</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">replicas:</span> <span class="number">2</span>
  <span class="attr">selector:</span>
    <span class="attr">matchLabels:</span>
      <span class="attr">app:</span> <span class="string">nginx</span>
  <span class="attr">template:</span>
    <span class="attr">metadata:</span>
      <span class="attr">labels:</span>
        <span class="attr">app:</span> <span class="string">nginx</span>
    <span class="attr">spec:</span>
      <span class="attr">containers:</span>
        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span>
          <span class="attr">image:</span> <span class="string">nginx:1.29.0</span>
          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>
          <span class="attr">ports:</span>
            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span>
              <span class="attr">containerPort:</span> <span class="number">80</span> <span class="comment"># 指定容器监听的端口</span>
              <span class="attr">protocol:</span> <span class="string">TCP</span> <span class="comment"># 指定端口使用的协议，TCP 表示端口处理 TCP 流量，适合 nginx 的 HTTP 服务</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">Service</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">nginx-svc</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span> <span class="comment"># Service 对外暴露的端口号</span>
      <span class="attr">targetPort:</span> <span class="number">80</span> <span class="comment"># Service 将流量转发到的目标 Pod 的端口号</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
  <span class="attr">selector:</span>
    <span class="attr">app:</span> <span class="string">nginx</span> <span class="comment"># Service 将流量路由到带有标签 app=nginx 的 Pod</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span> <span class="comment"># 指定 API 版本</span>
<span class="attr">kind:</span> <span class="string">Ingress</span> <span class="comment"># 指定资源类型为 Ingress，表示这是一个用于管理 HTTP/HTTPS 流量的 Kubernetes 资源</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">ingress-httpproxy</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">ingressClassName:</span> <span class="string">nginx</span> <span class="comment"># 指定此 Ingress 资源由名称为 nginx 的 IngressClass 处理，定义在 values.yaml 中 controller.ingressClassResource.name</span>
  <span class="attr">rules:</span> <span class="comment"># 定义了流量路由的规则，即如何根据域名（host）和路径（path）将请求转发到后端服务。</span>
    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.test-http-proxy.com</span> <span class="comment"># 指定此规则适用于请求的 HTTP 主机头（Host Header）为 www.test-http-proxy.com 的流量。客户端必须通过该域名访问, 如果省略 host，Ingress 会匹配所有域名（即通配规则）。</span>
      <span class="attr">http:</span> <span class="comment"># 定义了 HTTP 协议的路由规则</span>
        <span class="attr">paths:</span> <span class="comment"># 用于指定路径匹配规则</span>
          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span> <span class="comment"># 指定匹配的 URL 路径为 /，即根路径,这是最常见的路径，表示匹配所有以 / 开头的请求</span>
            <span class="attr">pathType:</span> <span class="string">Prefix</span> <span class="comment"># 定义路径匹配的类型为 Prefix，表示匹配以指定路径（/) 开头的所有请求</span>
            <span class="attr">backend:</span> <span class="comment"># 定义请求的转发目标，即后端服务</span>
              <span class="attr">service:</span>
                <span class="attr">name:</span> <span class="string">nginx-svc</span> <span class="comment"># 指定后端服务的名称为 nginx-svc.（必须存在于同一命名空间，或通过 &lt;namespace&gt;/&lt;service-name&gt; 跨命名空间引用）</span>
                <span class="attr">port:</span>
                  <span class="attr">number:</span> <span class="number">80</span> <span class="comment"># 指定目标 Service 的端口为 80</span></code></pre>



<blockquote>
<p>执行资源清单</p>
</blockquote>
<pre><code class="highlight bash">$ kubectl apply -f ingress-nginx-http-proxy.yaml 
deployment.apps/nginx-deploy created
service/nginx-svc created
ingress.networking.k8s.io/ingress-httpproxy created</code></pre>

<blockquote>
<p>查看部署资源</p>
</blockquote>
<pre><code class="highlight bash">$ kubectl get svc -o wide
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR
kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   59d   &lt;none&gt;
nginx-svc    ClusterIP   10.111.16.251   &lt;none&gt;        80/TCP    8s    app=nginx

$ kubectl get deployment -o wide 
NAME           READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR
nginx-deploy   2/2     2            2           16s   my-nginx     nginx:1.29.0   app=nginx

$ kubectl get pods -o wide
NAME                            READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES
nginx-deploy-6fc4ff86dc-n76xc   1/1     Running   0          22s   172.16.58.249   k8s-node02   &lt;none&gt;           &lt;none&gt;
nginx-deploy-6fc4ff86dc-nlmw5   1/1     Running   0          22s   172.16.85.206   k8s-node01   &lt;none&gt;           &lt;none&gt;

$ kubectl get ingress -o wide
NAME                CLASS   HOSTS                     ADDRESS   PORTS   AGE
ingress-httpproxy   nginx   www.test-http-proxy.com             80      18</code></pre>



<blockquote>
<p>修改主机 Host 文件</p>
<p>IP 可以是集群内部署了 Ingress-Controler 的任意一台服务器 IP</p>
</blockquote>
<pre><code class="highlight bash">10.20.1.140 www.test-http-proxy.com</code></pre>



<blockquote>
<p>测试访问 HTTP</p>
</blockquote>
<pre><code class="highlight bash">$ curl http://www.test-http-proxy.com
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;<span class="built_in">head</span>&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
html &#123; color-scheme: light dark; &#125;
body &#123; width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; &#125;
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>





<h2 id="2-Ingress-nginx-HTTPS-代理"><a href="#2-Ingress-nginx-HTTPS-代理" class="headerlink" title="2. Ingress-nginx HTTPS 代理"></a>2. Ingress-nginx HTTPS 代理</h2><h3 id="2-1-生成证书和私钥"><a href="#2-1-生成证书和私钥" class="headerlink" title="2.1 生成证书和私钥"></a>2.1 生成证书和私钥</h3><pre><code class="highlight bash"><span class="comment"># 1. 创建证书扩展文件</span>
$ vim http.ext
[ v3_req ]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = www.https-proxy.com
IP.1 = 127.0.0.1



<span class="comment"># 2. 创建证书</span>
<span class="comment"># 生成证书步骤1 ： 生成 CSR(证书签名请求) 和 私钥文件 tls.key</span>
openssl req -new -newkey rsa:2048 -sha256 -nodes -out tls.csr -keyout tls.key -subj <span class="string">&quot;/C=CN/ST=Beijing/L=Beijing/O=Super Inc./OU=Web Security/CN=www.https-proxy.com&quot;</span>

<span class="comment"># 生成证书步骤2 ： 生成证书tls.crt，并指定证书扩展文件</span>
openssl x509 -req -days 365 -<span class="keyword">in</span> tls.csr -signkey tls.key -out tls.crt -extfile http.ext -extensions v3_req

<span class="comment"># 查看生成的证书文件</span>
$ <span class="built_in">ls</span>
http.ext  tls.crt  tls.csr  tls.key



<span class="comment"># 3. 将证书和私钥存储到 Secret </span>
$ kubectl create secret tls ingress-nginx-tls  --key tls.key --cert tls.crt</code></pre>

<blockquote>
<p>查看证书 Secret</p>
<pre><code class="highlight bash"><span class="comment"># 查看 Secret</span>
$ kubectl get secret ingress-nginx-tls -n default
NAME                TYPE                DATA   AGE
ingress-nginx-tls   kubernetes.io/tls   2      22s

<span class="comment"># 查看 Secret 详情</span>
$ kubectl describe secret ingress-nginx-tls -n default
Name:         ingress-nginx-tls
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Type:  kubernetes.io/tls

Data
====
tls.crt:  1436 bytes
tls.key:  1708 bytes

<span class="comment"># 查看 Secret 数据</span>
$ kubectl get secret ingress-nginx-tls -n default -o yaml
apiVersion: v1
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQrRENDQXVDZ0F3SUJBZ0lVWk9iZ3V4cUR5bTlVWk1XUDROMEdnR3pTZkw4d0RRWUpLb1pJaHZjTkFRRUwKQlFBd2V6RUxNQWtHQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdNQjBKbGFXcHBibWN4RURBT0JnTlZCQWNNQjBKbAphV3BwYm1jeEV6QVJCZ05WQkFvTUNsTjFjR1Z5SUVsdVl5NHhGVEFUQmdOVkJBc01ERmRsWWlCVFpXTjFjbWwwCmVURWNNQm9HQTFVRUF3d1RkM2QzTG1oMGRIQnpMWEJ5YjNoNUxtTnZiVEFlRncweU5UQTJNamN3TXpBeE1qWmEKRncweU5qQTJNamN3TXpBeE1qWmFNSHN4Q3pBSkJnTlZCQVlUQWtOT01SQXdEZ1lEVlFRSURBZENaV2xxYVc1bgpNUkF3RGdZRFZRUUhEQWRDWldscWFXNW5NUk13RVFZRFZRUUtEQXBUZFhCbGNpQkpibU11TVJVd0V3WURWUVFMCkRBeFhaV0lnVTJWamRYSnBkSGt4SERBYUJnTlZCQU1NRTNkM2R5NW9kSFJ3Y3kxd2NtOTRlUzVqYjIwd2dnRWkKTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDUVJkTE1TZGpNdHQ2NzVPclVhbmNRNTN5eQpTZitEYVZ2Q2xPdjlGNDRkbG1GSFlrVVZXRW9VQkNIRzdCM1pBb0pRWGFpaEJRbUl5UTNJV0o2ODhsWVpEOU1XClgzU212MGp3Q1A0SVcxaTYyVHBwb0JVRHhlNlI3SHhBQXJXeG9pMzV6Q1lFVVRoZzY3OExhWDRma04xR0pYY3AKaERqZ1FFZ3NqTmVwdGNGRVBLaUxicTNhNVlkRWdpTmpVTnh3dWpKY1RFYllkMXgwUFh5V1lYVDNDV29Fd3JUZQozcU0zWUxTdThjRXdIT21VUW13Rzhvc1p4c2lLeXZjN2MwK3JWWUpqeXR1MFJDRVRjY3Njb2hhSWpqT25xaTN0ClVhd0tKbG9Fa3M5Y2dCb05BSzFodXRDRk9UbzJMY3VZSjA1akhSdy84VXI4RG4rc0w4cGFFSWNqZ2VqOUFnTUIKQUFHamREQnlNQWtHQTFVZEV3UUNNQUF3Q3dZRFZSMFBCQVFEQWdYZ01CTUdBMVVkSlFRTU1Bb0dDQ3NHQVFVRgpCd01CTUNRR0ExVWRFUVFkTUJ1Q0UzZDNkeTVvZEhSd2N5MXdjbTk0ZVM1amIyMkhCSDhBQUFFd0hRWURWUjBPCkJCWUVGTU9jdUNxSTVpL3kwazBtSDVWeFFNaEdhRTA0TUEwR0NTcUdTSWIzRFFFQkN3VUFBNElCQVFBeHZ5LzUKWGE1TjRxc3B4WS9rN0NPSTZoT2VBTitqaGF1SWVMeUkrb1UvczkzVnVLTkRrQ0ErakEyRHRWQmhtQ0xrVUdnbQo1enN5MkJHTndZZW4zV05mTXZZUmQ1ZFhjK3ZzUVNaV2VROWwwZ3FKaTdTeEQwaDJZa3BOUlJVcy84RXRSOUJFCmFKSmNkYTV1dlVwT2VFQ3JrWVhGRnIvK09yZW9Mdi9MV3dtK3VLRytLd204YUU1V3Z6czM0SUlqM1pOMlk1ZVQKVDh3dVhhOVJqbU1mRldaaDA4UHJUd3RXT1R1cW5TQUZ3Z2tpeTBab0RtNFd5amlUNmluZWpzTlpSa2ZCcW5ieQpwQVN0eGlmUWk4S2hRNVUzOEhkUVMzYnpNdnFiS2g3ZlZoamh4Si8wNVBQVHE0NGU3eG56dnlEazFUaC9vWnZ0CjJLdUZuVVkxLzlMayt1U1cKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2d0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktrd2dnU2xBZ0VBQW9JQkFRQ1FSZExNU2RqTXR0NjcKNU9yVWFuY1E1M3l5U2YrRGFWdkNsT3Y5RjQ0ZGxtRkhZa1VWV0VvVUJDSEc3QjNaQW9KUVhhaWhCUW1JeVEzSQpXSjY4OGxZWkQ5TVdYM1NtdjBqd0NQNElXMWk2MlRwcG9CVUR4ZTZSN0h4QUFyV3hvaTM1ekNZRVVUaGc2NzhMCmFYNGZrTjFHSlhjcGhEamdRRWdzak5lcHRjRkVQS2lMYnEzYTVZZEVnaU5qVU54d3VqSmNURWJZZDF4MFBYeVcKWVhUM0NXb0V3clRlM3FNM1lMU3U4Y0V3SE9tVVFtd0c4b3NaeHNpS3l2YzdjMCtyVllKanl0dTBSQ0VUY2NzYwpvaGFJampPbnFpM3RVYXdLSmxvRWtzOWNnQm9OQUsxaHV0Q0ZPVG8yTGN1WUowNWpIUncvOFVyOERuK3NMOHBhCkVJY2pnZWo5QWdNQkFBRUNnZ0VBQm1OOUpldzRPWS9OMWFxdSs3M2FMTDYweVhnQzVLTm4rNDl1S0NIZ3BSbEUKRUszcFFCSE40cUhiTldIcElYTmR2aExPVlR1eDlDTnVaT1V6RHZhNU9YaTNWaVNKelJvbjJwbnFBVE02L3VLQQpnUmhrWXl0NE9NWFhnUVhOc2hmQkt2QmFGNTRFSGR0RlNyWCt3OXJvU0MzL3RKcmFZajNKSkdYajVVRTdRQnI4CkxZemUvaXp0TVAyeENMSytwL3hJa1JpRVRaVmRubmtaM2FEY3JtcGlmOGRUcGZMbDVYUlRTNWtvbitXMmdybkUKdFd3L3lsWUVzcHo2c1BPRWV0bDNWK3VNYVlsOW9sTEZtQ1M1NUJxQjRid05zSHQyMDdzRmQ2SmdmRFdpZE9yUwpOSWdqRXMxOVphSU9VZitRN254VkQrNGNWaVFJbHhJc21CVGNONjRlOFFLQmdRRERSQmJzdWs3aHQ4MDRwR2wzCnN3M2Q5NndDZHZyOEVtdU41ZDdScEtudG5RdkQvaVJjTS9nNGZlU2czQ1lTbUpCSFNwUDFmZE0wODZBTXBIbzMKcmw2RGtZZ2diUGM4QndHZGp2NDJUdmFYUkQ1T2tnSjlPcDUreHZLMFpmZWJVeERlT3k2SmhNNFFJck5GZVF1dgpCZ0lJSUlSRTJzOTdlak1FclNPQ21CSlNjUUtCZ1FDOUpXOTYwVjIxdkk2L2lBUzZ5eitlSytJaVRxYjh3TUxwCjZjTWR0UEhTdy9URkJ0RVFpSGJvYTUwZER5YVh5TXR4dUpvamNLUXN5ZzdZWlFxQnpheEkwZEIvR0dqRzNlM1oKNjYwQXVXZ0pSN0VOYit3N2pDdjVGa0NWTEg1MEcxbXM2RjlBRXk0ajlOOStuSDlOTEtzbHZmcmNYbFIvY09HeQp6Q29adjdWdFRRS0JnUUNaYkJWckdSUERqQ3dsOWlDY0dVYXJBZC9YNis1V1FvN1paaVRGcWRDT1R4ZWdmajNKCmFGZis0d1BSVkVoaDBoZUN2RmsyeVE4N0NyVFZXaUpoUDVNcFl4NkhBN2JhSmxNaG5lbWxlRE9PTk9PVHptdEEKUTkrbWt1QzkxMlJPV1Z6bWo2K0lBNTM0MVpydjJpVFE5ekovZWpVUytLMlBRanQxMENnWGd5N2FNUUtCZ1FDMQpFdVdLV215djB2ZUZmSjJxaFhFOTV4enhZd0tSN2FlcmIxS1BXZTQzcThqajVnYTNJUzFVaTlFNVJJdlp1eXlvCmplVmlFQy9iZ1FSOVBSMjE3a1FFNG5nTGRENjZRek8wNzk0TFYzTzFqcUI5RUt6Q3hRcER4MzNFVVhndGh4RnUKYW5ibFRIZGJqTTE0MURFNm5JeXI4UmY3WjRMVkRpZkRsNWltVmRWRjhRS0JnUUNnTlB6enkrQUJtVHFLVytXbAoxb0lzUlJlQjdDd1pxUjNUZ0FBaXdKOEpRTFdoREdiQzdJQ0FLVlZkNGZjeUtXVlovRWIrK3RZdUc5ZUpWUkY4CldzU2J1Y0phcktBN1k4UDUydDVtWUp6ZkZjb0hLNXVSVFlOVElFM2w4YmhnSmxqaVJPTER1a2N6cEhVdkJLZkYKYVg4UjNtR3hhZFJ4U25TZUhiN2QvNUFaVlE9PQotLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tCg==
kind: Secret
metadata:
  creationTimestamp: <span class="string">&quot;2025-06-27T03:10:37Z&quot;</span>
  name: ingress-nginx-tls
  namespace: default
  resourceVersion: <span class="string">&quot;13338253&quot;</span>
  uid: fffb5d77-97c4-4237-8be9-a487d96dbf34
<span class="built_in">type</span>: kubernetes.io/tls</code></pre>
</blockquote>
<h3 id="2-2-创建资源清单"><a href="#2-2-创建资源清单" class="headerlink" title="2.2 创建资源清单"></a>2.2 创建资源清单</h3><p>资源清单：<code>ingress-nginx-https-proxy.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>
<span class="attr">kind:</span> <span class="string">Deployment</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">nginx-deploy</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">replicas:</span> <span class="number">2</span>
  <span class="attr">selector:</span>
    <span class="attr">matchLabels:</span>
      <span class="attr">app:</span> <span class="string">nginx-https</span>
  <span class="attr">template:</span>
    <span class="attr">metadata:</span>
      <span class="attr">labels:</span>
        <span class="attr">app:</span> <span class="string">nginx-https</span>
    <span class="attr">spec:</span>
      <span class="attr">containers:</span>
        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span>
          <span class="attr">image:</span> <span class="string">nginx:1.29.0</span>
          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>
          <span class="attr">ports:</span>
            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span>
              <span class="attr">containerPort:</span> <span class="number">80</span> <span class="comment"># 指定容器监听的端口</span>
              <span class="attr">protocol:</span> <span class="string">TCP</span> <span class="comment"># 指定端口使用的协议，TCP 表示端口处理 TCP 流量，适合 nginx 的 HTTP 服务</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">Service</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">nginx-https-svc</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span> <span class="comment"># Service 对外暴露的端口号</span>
      <span class="attr">targetPort:</span> <span class="number">80</span> <span class="comment"># Service 将流量转发到的目标 Pod 的端口号</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
  <span class="attr">selector:</span>
    <span class="attr">app:</span> <span class="string">nginx-https</span> <span class="comment"># Service 将流量路由到带有标签 app=nginx-https 的 Pod</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span> <span class="comment"># 指定 API 版本</span>
<span class="attr">kind:</span> <span class="string">Ingress</span> <span class="comment"># 指定资源类型为 Ingress，表示这是一个用于管理 HTTP/HTTPS 流量的 Kubernetes 资源</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">ingress-https-proxy</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
  <span class="attr">annotations:</span>
    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;true&quot;</span> <span class="comment"># HTTP 重定向为HTTPS, true表示强制重定向</span>
<span class="attr">spec:</span>
  <span class="attr">ingressClassName:</span> <span class="string">nginx</span> <span class="comment"># 指定此 Ingress 资源由名称为 nginx 的 IngressClass 处理，定义在 values.yaml 中 controller.ingressClassResource.name</span>
  <span class="attr">rules:</span> <span class="comment"># 定义了流量路由的规则，即如何根据域名（host）和路径（path）将请求转发到后端服务。</span>
    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.https-proxy.com</span> <span class="comment"># 指定此规则适用于请求的 HTTP 主机头（Host Header）为 www.www.https-proxy.com 的流量。客户端必须通过该域名访问, 如果省略 host，Ingress 会匹配所有域名（即通配规则）。</span>
      <span class="attr">http:</span> <span class="comment"># 定义了 HTTP 协议的路由规则</span>
        <span class="attr">paths:</span> <span class="comment"># 用于指定路径匹配规则</span>
          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span> <span class="comment"># 指定匹配的 URL 路径为 /，即根路径,这是最常见的路径，表示匹配所有以 / 开头的请求</span>
            <span class="attr">pathType:</span> <span class="string">Prefix</span> <span class="comment"># 定义路径匹配的类型为 Prefix，表示匹配以指定路径（/) 开头的所有请求</span>
            <span class="attr">backend:</span> <span class="comment"># 定义请求的转发目标，即后端服务</span>
              <span class="attr">service:</span>
                <span class="attr">name:</span> <span class="string">nginx-https-svc</span> <span class="comment"># 指定后端服务的名称为 nginx-https-svc.（必须存在于同一命名空间，或通过 &lt;namespace&gt;/&lt;service-name&gt; 跨命名空间引用）</span>
                <span class="attr">port:</span>
                  <span class="attr">number:</span> <span class="number">80</span> <span class="comment"># 指定目标 Service 的端口为 80</span>
  <span class="attr">tls:</span>
    <span class="bullet">-</span> <span class="attr">hosts:</span>
        <span class="bullet">-</span> <span class="string">www.https-proxy.com</span> <span class="comment"># 指定域名</span>
      <span class="attr">secretName:</span> <span class="string">ingress-nginx-tls</span> <span class="comment"># 证书和私钥保存的 Secret</span></code></pre>



<p>可以看到Ingress添加TLS配置也非常简单，只需要在 spec下添加一个 tls 字段即可：</p>
<ul>
<li>hosts：证书所授权的域名列表</li>
<li>secretName：证书的 Secret 名字</li>
<li>ingressClassName: ingress class 的名字，1.22+需要配置</li>
</ul>
<blockquote>
<p>执行资源清单</p>
</blockquote>
<pre><code class="highlight bash">$ kubectl apply -f ingress-nginx-https-proxy.yaml 
deployment.apps/nginx-deploy created
service/nginx-https-svc created
ingress.networking.k8s.io/ingress-https-proxy created</code></pre>

<blockquote>
<p>查看部署资源</p>
</blockquote>
<pre><code class="highlight bash">$ kubectl get svc -o wide
NAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR
kubernetes        ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP   59d   &lt;none&gt;
nginx-https-svc   ClusterIP   10.99.219.148   &lt;none&gt;        80/TCP    96s   app=nginx-https

$ kubectl get deployment -o wide
NAME           READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR
nginx-deploy   2/2     2            2           8s    my-nginx     nginx:1.29.0   app=nginx-https

$ kubectl get pods -o wide
NAME                            READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES
nginx-deploy-7d6bd7f587-47kqv   1/1     Running   0          21s   172.16.85.213   k8s-node01   &lt;none&gt;           &lt;none&gt;
nginx-deploy-7d6bd7f587-92hhz   1/1     Running   0          21s   172.16.58.233   k8s-node02   &lt;none&gt;           &lt;none&gt;

$ kubectl get ingress -o wide
NAME                  CLASS   HOSTS                 ADDRESS   PORTS     AGE
ingress-https-proxy   nginx   www.https-proxy.com             80, 443   2m57s</code></pre>

<blockquote>
<p>修改主机 Host 文件</p>
<p>IP 可以是集群内部署了 Ingress-Controler 的任意一台服务器 IP</p>
</blockquote>
<pre><code class="highlight bash">10.20.1.140 www.https-proxy.com</code></pre>

<blockquote>
<p>测试访问 HTTPS访问<br>端口号通过命令：kubectl get svc -n ingress-nginx 查看 443 映射端口</p>
</blockquote>
<pre><code class="highlight bash"><span class="comment"># 用命令行测试 https 请求，其中 -k 表示忽略自签名证书警告</span>
$ curl -k https://www.https-proxy.com
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;<span class="built_in">head</span>&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
html &#123; color-scheme: light dark; &#125;
body &#123; width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; &#125;
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>



<p><img src="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/07/04/20250704-152114.png" alt="浏览器访问HTTPS"></p>
<p>需要将自签发的 tls.crt 证书导入到浏览器中，否则会有 “不安全” 的告警提示</p>
<p>如果在ingress中设置tls,即默认的http会被强制重定向到https，http即不可访问,如果需要http与https同时可以使用可以设置</p>
<ul>
<li>nginx.ingress.kubernetes.io&#x2F;ssl-redirect: “false” ：禁用强制重定向，这样可以同时使用http与https</li>
</ul>
<h2 id="3-Ingress-nginx-BasicAuth-代理"><a href="#3-Ingress-nginx-BasicAuth-代理" class="headerlink" title="3. Ingress-nginx BasicAuth 代理"></a>3. Ingress-nginx BasicAuth 代理</h2><p>有些网站可能需要通过密码来访问，对于这类网站可以使用 Nginx 的 basic-auth 设置密码访 问，具体方法如下，由于需要使用 htpasswd 工具，所以需要安装httpd。</p>
<pre><code class="highlight bash"><span class="comment"># 安装 htpasswd 工具</span>
$ dnf -y install httpd-tools

<span class="comment"># 使用 htpasswd 命令创建一个新的基本认证密码文件 auth，并为用户 george 设置密码。</span>
$ htpasswd -c auth george
New password: 
Re-<span class="built_in">type</span> new password: 
Adding password <span class="keyword">for</span> user george

<span class="comment"># 创建一个 Kubernetes Secret 资源，类型为 generic，用于存储基本认证的密码文件 auth，以便在 Ingress 或 Nginx 中启用 HTTP 基本认证。</span>
$ kubectl create secret generic ingress-basic-auth --from-file=auth</code></pre>

<blockquote>
<p>查看 Secret</p>
<pre><code class="highlight bash">$ kubectl get secret ingress-basic-auth -o yaml
apiVersion: v1
data:
  auth: Z2VvcmdlOiRhcHIxJEpoZFB6aVNPJDVXcjhqTDYyQll5Nm5aa3ZHWlB3ejAK
kind: Secret
metadata:
  creationTimestamp: <span class="string">&quot;2025-06-27T06:12:07Z&quot;</span>
  name: ingress-basic-auth
  namespace: default
  resourceVersion: <span class="string">&quot;13361989&quot;</span>
  uid: 9550e4af-4a83-48d7-9b40-fc207303a192
<span class="built_in">type</span>: Opaque</code></pre>
</blockquote>
<p><strong>创建包含密码认证的Ingress</strong>：</p>
<ul>
<li>nginx.ingress.kubernetes.io&#x2F;auth-type：认证类型，可以是 basic 和 digest</li>
<li>nginx.ingress.kubernetes.io&#x2F;auth-secret：密码文件的 Secret 名称</li>
<li>nginx.ingress.kubernetes.io&#x2F;auth-realm：需要密码认证的消息提醒</li>
</ul>
<p><strong>资源清单</strong></p>
<p><code>ingress-nginx-basic-auth.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>
<span class="attr">kind:</span> <span class="string">Deployment</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">nginx-deploy</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">replicas:</span> <span class="number">2</span>
  <span class="attr">selector:</span>
    <span class="attr">matchLabels:</span>
      <span class="attr">app:</span> <span class="string">nginx</span>
  <span class="attr">template:</span>
    <span class="attr">metadata:</span>
      <span class="attr">labels:</span>
        <span class="attr">app:</span> <span class="string">nginx</span>
    <span class="attr">spec:</span>
      <span class="attr">containers:</span>
        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span>
          <span class="attr">image:</span> <span class="string">nginx:1.29.0</span>
          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>
          <span class="attr">ports:</span>
            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span>
              <span class="attr">containerPort:</span> <span class="number">80</span> <span class="comment"># 指定容器监听的端口</span>
              <span class="attr">protocol:</span> <span class="string">TCP</span> <span class="comment"># 指定端口使用的协议，TCP 表示端口处理 TCP 流量，适合 nginx 的 HTTP 服务</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">Service</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">nginx-svc</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span> <span class="comment"># Service 对外暴露的端口号</span>
      <span class="attr">targetPort:</span> <span class="number">80</span> <span class="comment"># Service 将流量转发到的目标 Pod 的端口号</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
  <span class="attr">selector:</span>
    <span class="attr">app:</span> <span class="string">nginx</span> <span class="comment"># Service 将流量路由到带有标签 app=nginx 的 Pod</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span> <span class="comment"># 指定 API 版本</span>
<span class="attr">kind:</span> <span class="string">Ingress</span> <span class="comment"># 指定资源类型为 Ingress，表示这是一个用于管理 HTTP/HTTPS 流量的 Kubernetes 资源</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">ingress-basic-auth</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
  <span class="attr">annotations:</span>
    <span class="attr">nginx.ingress.kubernetes.io/auth-type:</span> <span class="string">basic</span> <span class="comment"># 认证类型</span>
    <span class="attr">nginx.ingress.kubernetes.io/auth-secret:</span> <span class="string">ingress-basic-auth</span> <span class="comment"># 密码文件的 Secret 名称</span>
    <span class="attr">nginx.ingress.kubernetes.io/auth-realm:</span> <span class="string">&#x27;请输入用户名和密码：&#x27;</span> <span class="comment"># 需要密码认证的消息提醒</span>
<span class="attr">spec:</span>
  <span class="attr">ingressClassName:</span> <span class="string">nginx</span> <span class="comment"># 指定此 Ingress 资源由名称为 nginx 的 IngressClass 处理，定义在 values.yaml 中 controller.ingressClassResource.name</span>
  <span class="attr">rules:</span> <span class="comment"># 定义了流量路由的规则，即如何根据域名（host）和路径（path）将请求转发到后端服务。</span>
    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">auth.basic.com</span> <span class="comment"># 指定此规则适用于请求的 HTTP 主机头（Host Header）为 auth.basic.com 的流量。</span>
      <span class="attr">http:</span> <span class="comment"># 定义了 HTTP 协议的路由规则</span>
        <span class="attr">paths:</span> <span class="comment"># 用于指定路径匹配规则</span>
          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span> <span class="comment"># 指定匹配的 URL 路径为 /，即根路径,这是最常见的路径，表示匹配所有以 / 开头的请求</span>
            <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span> <span class="comment"># 表示路径匹配行为由 Ingress 控制器定义,对于 nginx Ingress 控制器，ImplementationSpecific 通常等同于 Prefix，即匹配以指定路径开头的请求。</span>
            <span class="attr">backend:</span> <span class="comment"># 定义请求的转发目标，即后端服务</span>
              <span class="attr">service:</span>
                <span class="attr">name:</span> <span class="string">nginx-svc</span> <span class="comment"># 指定后端服务的名称为 nginx-svc.（必须存在于同一命名空间，或通过 &lt;namespace&gt;/&lt;service-name&gt; 跨命名空间引用）</span>
                <span class="attr">port:</span>
                  <span class="attr">number:</span> <span class="number">80</span> <span class="comment"># 指定目标 Service 的端口为 80</span></code></pre>



<blockquote>
<p>执行资源清单</p>
<pre><code class="highlight bash">$ kubectl apply -f ingress-nginx-basic-auth.yaml</code></pre>
</blockquote>
<blockquote>
<p>修改主机 Host 文件</p>
<p>IP 可以是集群内部署了 Ingress-Controler 的任意一台服务器 IP</p>
</blockquote>
<pre><code class="highlight bash">10.20.1.140 auth.basic.com</code></pre>



<blockquote>
<p>浏览器访问测试</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/07/04/20250704-152550.png" alt="basic auth 认证测试-登录用户名/密码"></p>
<p><img src="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/07/04/20250704-152642.png" alt="basic auth 认证测试-登录成功"></p>
<h2 id="4-Ingress-nginx-域名重定向"><a href="#4-Ingress-nginx-域名重定向" class="headerlink" title="4. Ingress-nginx 域名重定向"></a>4. Ingress-nginx 域名重定向</h2><p><strong>官方说明</strong>：<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#permanent-redirect">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#permanent-redirect</a></p>
<p>在 Nginx 作为代理服务器时，Redirect 可用于域名的重定向，比如访问 old.com 被重定向到 new.com。Ingress 可以更简单的实现 Redirect 功能，接下来用 ingress-redirect.com 作为旧域名， <a target="_blank" rel="noopener" href="http://www.baidu.com/">www.baidu.com</a> 作为新域名进行演示：</p>
<p><strong>相关配置项</strong>：</p>
<ul>
<li>permanent-redirect：重定向到的域名</li>
<li>permanent-redirect-code：重定向代码，不配置默认301(永久重定向,如有其他原因可自行配置)</li>
</ul>
<p>资源清单：<code>ingress-nginx-redirect.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>
<span class="attr">kind:</span> <span class="string">Deployment</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">nginx-deploy</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">replicas:</span> <span class="number">2</span>
  <span class="attr">selector:</span>
    <span class="attr">matchLabels:</span>
      <span class="attr">app:</span> <span class="string">nginx</span>
  <span class="attr">template:</span>
    <span class="attr">metadata:</span>
      <span class="attr">labels:</span>
        <span class="attr">app:</span> <span class="string">nginx</span>
    <span class="attr">spec:</span>
      <span class="attr">containers:</span>
        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span>
          <span class="attr">image:</span> <span class="string">nginx:1.29.0</span>
          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>
          <span class="attr">ports:</span>
            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span>
              <span class="attr">containerPort:</span> <span class="number">80</span> <span class="comment"># 指定容器监听的端口</span>
              <span class="attr">protocol:</span> <span class="string">TCP</span> <span class="comment"># 指定端口使用的协议，TCP 表示端口处理 TCP 流量，适合 nginx 的 HTTP 服务</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">Service</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">nginx-svc</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span> <span class="comment"># Service 对外暴露的端口号</span>
      <span class="attr">targetPort:</span> <span class="number">80</span> <span class="comment"># Service 将流量转发到的目标 Pod 的端口号</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
  <span class="attr">selector:</span>
    <span class="attr">app:</span> <span class="string">nginx</span> <span class="comment"># Service 将流量路由到带有标签 app=nginx-https 的 Pod</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span> <span class="comment"># 指定 API 版本</span>
<span class="attr">kind:</span> <span class="string">Ingress</span> <span class="comment"># 指定资源类型为 Ingress，表示这是一个用于管理 HTTP/HTTPS 流量的 Kubernetes 资源</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">ingress-redirect</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
  <span class="attr">annotations:</span>
    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span> <span class="comment"># 指定使用的Ingress控制器类名，与 ingressClassName 作用相同</span>
    <span class="attr">nginx.ingress.kubernetes.io/permanent-redirect:</span> <span class="string">https://www.baidu.com</span> <span class="comment"># 永久重定向网址</span>
    <span class="attr">nginx.ingress.kubernetes.io/permanent-redirect-code:</span> <span class="string">&#x27;301&#x27;</span> <span class="comment"># 永久重定向状态码</span>
<span class="attr">spec:</span>
  <span class="attr">ingressClassName:</span> <span class="string">nginx</span> <span class="comment"># 指定此 Ingress 资源由名称为 nginx 的 IngressClass 处理，定义在 values.yaml 中 controller.ingressClassResource.name</span>
  <span class="attr">rules:</span> <span class="comment"># 定义了流量路由的规则，即如何根据域名（host）和路径（path）将请求转发到后端服务。</span>
    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">ingress-redirect.com</span> <span class="comment"># 指定此规则适用于请求的 HTTP 主机头（Host Header）为 ingress-redirect.com 的流量。客户端必须通过该域名访问, 如果省略 host，Ingress 会匹配所有域名（即通配规则）。</span></code></pre>

<blockquote>
<p>执行资源清单</p>
<pre><code class="highlight bash">$ kubectl apply -f ingress-nginx-redirect.yaml</code></pre>
</blockquote>
<blockquote>
<p>修改主机host文件，添加域名映射</p>
<p>IP 可以是集群内部署了 Ingress-Controler 的任意一台服务器 IP</p>
<pre><code class="highlight plaintext">10.20.1.140 ingress-redirect.com</code></pre>
</blockquote>
<blockquote>
<p>浏览器访问测试</p>
<p><a target="_blank" rel="noopener" href="http://ingress-redirect.com/">http://ingress-redirect.com</a></p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/06/27/20250627-134058.png" alt="域名重定向"></p>
<h2 id="5-Ingress-nginx-Rewrite"><a href="#5-Ingress-nginx-Rewrite" class="headerlink" title="5. Ingress-nginx  Rewrite"></a>5. Ingress-nginx  Rewrite</h2><p>官方示例：<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/examples/rewrite/">https://kubernetes.github.io/ingress-nginx/examples/rewrite/</a></p>
<p><strong>相关配置项</strong>：</p>
<ul>
<li>nginx.ingress.kubernetes.io&#x2F;rewrite-target: 重定向配置</li>
</ul>
<h3 id="5-1-案例"><a href="#5-1-案例" class="headerlink" title="5.1 案例"></a>5.1 案例</h3><p>资源清单：<code>ingress-nginx-rewrite.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>
<span class="attr">kind:</span> <span class="string">Deployment</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">nginx-deploy</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">replicas:</span> <span class="number">2</span>
  <span class="attr">selector:</span>
    <span class="attr">matchLabels:</span>
      <span class="attr">app:</span> <span class="string">nginx</span>
  <span class="attr">template:</span>
    <span class="attr">metadata:</span>
      <span class="attr">labels:</span>
        <span class="attr">app:</span> <span class="string">nginx</span>
    <span class="attr">spec:</span>
      <span class="attr">containers:</span>
        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span>
          <span class="attr">image:</span> <span class="string">nginx:1.29.0</span>
          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>
          <span class="attr">ports:</span>
            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span>
              <span class="attr">containerPort:</span> <span class="number">80</span> <span class="comment"># 指定容器监听的端口</span>
              <span class="attr">protocol:</span> <span class="string">TCP</span> <span class="comment"># 指定端口使用的协议，TCP 表示端口处理 TCP 流量，适合 nginx 的 HTTP 服务</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">Service</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">nginx-svc</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span> <span class="comment"># Service 对外暴露的端口号</span>
      <span class="attr">targetPort:</span> <span class="number">80</span> <span class="comment"># Service 将流量转发到的目标 Pod 的端口号</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
  <span class="attr">selector:</span>
    <span class="attr">app:</span> <span class="string">nginx</span> <span class="comment"># Service 将流量路由到带有标签 app=nginx-https 的 Pod</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span> <span class="comment"># 指定 API 版本</span>
<span class="attr">kind:</span> <span class="string">Ingress</span> <span class="comment"># 指定资源类型为 Ingress，表示这是一个用于管理 HTTP/HTTPS 流量的 Kubernetes 资源</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">ingress-rewrite</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
  <span class="attr">annotations:</span>
    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/$2</span> <span class="comment"># 对匹配的 URL 路径进行重写。$2 引用正则表达式捕获组</span>
<span class="attr">spec:</span>
  <span class="attr">ingressClassName:</span> <span class="string">nginx</span> <span class="comment"># 指定此 Ingress 资源由名称为 nginx 的 IngressClass 处理，定义在 values.yaml 中 controller.ingressClassResource.name</span>
  <span class="attr">rules:</span> <span class="comment"># 定义了流量路由的规则，即如何根据域名（host）和路径（path）将请求转发到后端服务。</span>
    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">ingress-rewrite.com</span> <span class="comment"># 定义流量路由规则，基于主机名（host）。这里指定只处理发送到 ingress-rewrite.com 的请求</span>
      <span class="attr">http:</span>
        <span class="attr">paths:</span>
          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/api(/|$)(.*)</span> <span class="comment"># 匹配以 /api 开头的路径，后面可以跟 / 或直接结束（|$ 表示路径结束），并捕获剩余部分 (.*) 作为捕获组 $2， 例如：/api、/api/、/api/anything 都会匹配</span>
            <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span> <span class="comment"># 路径匹配的具体行为由 Ingress 控制器（NGINX）定义。通常与正则表达式结合使用，允许更灵活的匹配逻辑</span>
            <span class="attr">backend:</span>
              <span class="attr">service:</span>
                <span class="attr">name:</span> <span class="string">nginx-svc</span>
                <span class="attr">port:</span>
                  <span class="attr">number:</span> <span class="number">80</span></code></pre>



<blockquote>
<p>执行资源清单</p>
<pre><code class="highlight bash">$ kubectl apply -f ingress-nginx-rewrite.yaml</code></pre>
</blockquote>
<blockquote>
<p>修改主机host文件，添加域名映射</p>
<p>IP 可以是集群内部署了 Ingress-Controler 的任意一台服务器 IP</p>
<pre><code class="highlight plaintext">10.20.1.140 ingress-rewrite.com</code></pre>
</blockquote>
<blockquote>
<p>访问域名，不加 &#x2F;api 前缀：404</p>
<p><img src="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/07/04/20250704-152851.png" alt="不加 /api 前缀：404"></p>
</blockquote>
<blockquote>
<p>访问域名，添加 &#x2F;api 前缀：成功访问到 nginx-svc Service 的默认页面</p>
<p><img src="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/07/04/20250704-152935.png" alt="添加 /api 前缀：成功访问到 nginx-svc Service 的默认页面"></p>
</blockquote>
<blockquote>
<p>访问域名，添加路径 &#x2F;api&#x2F;index.html 成功访问到 nginx-svc Service 的 &#x2F;index.html 页面</p>
<p><img src="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/07/04/20250704-153050.png" alt="访问路径 /api/index.html 成功访问到 nginx-svc Service 的 /index.html 页面"></p>
</blockquote>
<h3 id="5-1-rewrite-和-redirect"><a href="#5-1-rewrite-和-redirect" class="headerlink" title="5.1 rewrite 和 redirect"></a>5.1 rewrite 和 redirect</h3><p>在 Ingress 控制器中，rewrite 和 redirect 是两种不同的操作，它们的作用和行为有所不同：</p>
<p><strong>Rewrite（重写）</strong></p>
<ul>
<li>作用：重写是指修改请求的路径，但是客户端不会察觉到这个变化，它仅在服务器内部发生。在 Kubernetes 中，可以通过 Ingress 的注解来配置重写规则</li>
<li>示例：比如你有一个服务部署在 &#x2F;v1 路径下，但是你希望用户访问时不需要输入 &#x2F;v1，那么你可以使用重写将请求从根路径 &#x2F; 重写到 &#x2F;v1</li>
</ul>
<p><strong>Redirect（重定向）</strong></p>
<ul>
<li>作用：重定向是指服务器向客户端发出一个新的 URL，让客户端进行新的请求。客户端会收到一个 HTTP 3xx 状态码，然后根据其中的重定向地址进行新的请求。这意味着客户端会知道发生了重定向，它会发起新的请求</li>
<li>示例：比如你有一个网站的旧地址是 <a target="_blank" rel="noopener" href="http://example.com,但是你希望所有的请求都转发到/">http://example.com，但是你希望所有的请求都转发到</a> <a target="_blank" rel="noopener" href="https://example.com,这时你就可以使用重定向将所有的/">https://example.com，这时你就可以使用重定向将所有的</a> HTTP 请求重定向到 HTTPS</li>
</ul>
<p><strong>区别：</strong></p>
<ul>
<li>影响范围：Rewrite 只在服务器内部修改请求路径，不会影响到客户端，而 Redirect 则会向客户端发送一个新的 URL，让客户端发起新的请求</li>
<li>状态码：Rewrite 不涉及状态码的改变，而 Redirect 会向客户端发送一个重定向的 HTTP 状态码（例如 301 永久重定向、302 临时重定向等）</li>
<li>可见性：Rewrite 对于客户端来说是透明的，而 Redirect 则会告知客户端发生了重定向</li>
</ul>
<p>在选择使用 Rewrite 还是 Redirect 时，需要根据具体的需求来决定。如果你希望在不修改客户端请求的情况下修改路径，那么使用 Rewrite；如果你希望客户端知道发生了重定向，并且根据新的 URL 进行新的请求，那么使用 Redirect。</p>
<h2 id="6-Ingress-nginx-错误代码重定向"><a href="#6-Ingress-nginx-错误代码重定向" class="headerlink" title="6. Ingress-nginx 错误代码重定向"></a>6. Ingress-nginx 错误代码重定向</h2><p>这里的错误代码重定向分为全局设置与某个ingress设置</p>
<h3 id="6-1-默认错误后端（全局）"><a href="#6-1-默认错误后端（全局）" class="headerlink" title="6.1 默认错误后端（全局）"></a>6.1 默认错误后端（全局）</h3><p>错误代码重定向功能需要使用 helm 重新部署 ingress-nginx 控制器部署步骤如下：</p>
<h4 id="6-1-1-修改-values-yaml"><a href="#6-1-1-修改-values-yaml" class="headerlink" title="6.1.1 修改 values.yaml"></a>6.1.1 修改 values.yaml</h4><pre><code class="highlight yaml"><span class="comment"># 修改 ingress-nginx 目录内 valume.yml 文件</span>
<span class="attr">defaultBackend:</span>
  <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启全局错误码重定向</span>
  <span class="attr">name:</span> <span class="string">defaultbackend</span>
  <span class="attr">image:</span>
    <span class="attr">registry:</span> <span class="string">registry.k8s.io</span>
    <span class="attr">image:</span> <span class="string">defaultbackend-amd64</span>
    <span class="attr">tag:</span> <span class="string">&quot;1.5&quot;</span>
    <span class="attr">pullPolicy:</span> <span class="string">IfNotPresent</span></code></pre>

<p><em>这里的镜像是 ingress-nginx 的默认镜像，需要提前下载并导入到服务器中</em></p>
<h4 id="6-1-2-更新-Ingress-Nginx"><a href="#6-1-2-更新-Ingress-Nginx" class="headerlink" title="6.1.2 更新 Ingress Nginx"></a>6.1.2 更新 Ingress Nginx</h4><pre><code class="highlight bash"><span class="comment"># 更新 Ingress Nginx</span>
$ helm upgrade ingress-nginx . -n ingress-nginx

<span class="comment"># 查看 Pod 是否更新，如果是则为刚创建的</span>
$ kubectl get pod -n ingress-nginx
NAME                                           READY   STATUS        RESTARTS   AGE
ingress-nginx-controller-cpbcd                 1/1     Terminating   0          31h
ingress-nginx-controller-szlfb                 1/1     Running       0          25s
ingress-nginx-defaultbackend-f7797494f-t77x4   1/1     Running       0          39s
<span class="comment"># 旧的 controller 正在关闭，新创建的在运行中，Ingress Nginx 更新成功</span></code></pre>



<h4 id="6-1-3-测试资源清单"><a href="#6-1-3-测试资源清单" class="headerlink" title="6.1.3 测试资源清单"></a>6.1.3 测试资源清单</h4><p><code>ingress-nginx-global-errorcode.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>
<span class="attr">kind:</span> <span class="string">Deployment</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">nginx-deploy</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">replicas:</span> <span class="number">2</span>
  <span class="attr">selector:</span>
    <span class="attr">matchLabels:</span>
      <span class="attr">app:</span> <span class="string">nginx</span>
  <span class="attr">template:</span>
    <span class="attr">metadata:</span>
      <span class="attr">labels:</span>
        <span class="attr">app:</span> <span class="string">nginx</span>
    <span class="attr">spec:</span>
      <span class="attr">containers:</span>
        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span>
          <span class="attr">image:</span> <span class="string">nginx:1.29.0</span>
          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>
          <span class="attr">ports:</span>
            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span>
              <span class="attr">containerPort:</span> <span class="number">80</span>
              <span class="attr">protocol:</span> <span class="string">TCP</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">Service</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">nginx-svc</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span>
      <span class="attr">targetPort:</span> <span class="number">80</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
  <span class="attr">selector:</span>
    <span class="attr">app:</span> <span class="string">nginx</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span> <span class="comment"># 指定 API 版本</span>
<span class="attr">kind:</span> <span class="string">Ingress</span> <span class="comment"># 指定资源类型为 Ingress，表示这是一个用于管理 HTTP/HTTPS 流量的 Kubernetes 资源</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">ingress-global-errorcode</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">ingressClassName:</span> <span class="string">nginx</span> <span class="comment"># 指定此 Ingress 资源由名称为 nginx 的 IngressClass 处理，定义在 values.yaml 中 controller.ingressClassResource.name</span>
  <span class="attr">rules:</span> <span class="comment"># 定义了流量路由的规则，即如何根据域名（host）和路径（path）将请求转发到后端服务。</span>
    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">global.errorcode.com</span> <span class="comment"># 指定此规则适用于请求的 HTTP 主机头（Host Header）为 global.errorcode.com 的流量。</span>
      <span class="attr">http:</span> <span class="comment"># 定义了 HTTP 协议的路由规则</span>
        <span class="attr">paths:</span> <span class="comment"># 用于指定路径匹配规则</span>
          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span> <span class="comment"># 指定匹配的 URL 路径为 /，即根路径,这是最常见的路径，表示匹配所有以 / 开头的请求</span>
            <span class="attr">pathType:</span> <span class="string">Prefix</span> <span class="comment"># 定义路径匹配的类型为 Prefix，表示匹配以指定路径（/) 开头的所有请求</span>
            <span class="attr">backend:</span> <span class="comment"># 定义请求的转发目标，即后端服务</span>
              <span class="attr">service:</span>
                <span class="attr">name:</span> <span class="string">nginx-svc</span> <span class="comment"># 指定后端服务的名称为 nginx-svc.（必须存在于同一命名空间，或通过 &lt;namespace&gt;/&lt;service-name&gt; 跨命名空间引用）</span>
                <span class="attr">port:</span>
                  <span class="attr">number:</span> <span class="number">80</span> <span class="comment"># 指定目标 Service 的端口为 80</span></code></pre>



<blockquote>
<p>执行资源清单</p>
<pre><code class="highlight bash">$ kubectl apply -f ingress-nginx-global-errorcode.yaml</code></pre>
</blockquote>
<blockquote>
<p>修改主机host文件，添加域名映射</p>
<p>IP 可以是集群内部署了 Ingress-Controler 的任意一台服务器 IP</p>
<pre><code class="highlight plaintext">10.20.1.140 global.errorcode.com</code></pre>
</blockquote>
<p>当开启 Ingress Nginx 全局错误码重定向时，此时请求不存在的路径，服务端会返回默认的内容</p>
<p>例如请求 <a target="_blank" rel="noopener" href="http://ingress-rewrite.com/123.html">http://ingress-rewrite.com/123.html</a></p>
<p><img src="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/06/28/20250628-172533.png" alt="全局错误码重定向"></p>
<h3 id="6-2-单独声明错误后端"><a href="#6-2-单独声明错误后端" class="headerlink" title="6.2 单独声明错误后端"></a>6.2 单独声明错误后端</h3><p><strong>设置某个ingress的错误重定向会覆盖全局设置，示例如下</strong></p>
<ul>
<li>nginx.ingress.kubernetes.io&#x2F;default-backend: 默认后端service名称</li>
<li>nginx.ingress.kubernetes.io&#x2F;custom-http-errors: 那些错误代理重定向到默认后端svc</li>
</ul>
<p><strong>资源清单</strong></p>
<p><code>ingress-nginx-single-errorcode.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>
<span class="attr">kind:</span> <span class="string">Deployment</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">error-code-deploy</span> <span class="comment"># 用于当请求出现规定的错误码时，返回默认内容</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">replicas:</span> <span class="number">2</span>
  <span class="attr">selector:</span>
    <span class="attr">matchLabels:</span>
      <span class="attr">app:</span> <span class="string">error</span>
  <span class="attr">template:</span>
    <span class="attr">metadata:</span>
      <span class="attr">labels:</span>
        <span class="attr">app:</span> <span class="string">error</span>
    <span class="attr">spec:</span>
      <span class="attr">containers:</span>
        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">error-web</span>
          <span class="attr">image:</span> <span class="string">registry.k8s.io/defaultbackend-amd64:1.5</span>
          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>
          <span class="attr">ports:</span>
            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span>
              <span class="attr">containerPort:</span> <span class="number">80</span>
              <span class="attr">protocol:</span> <span class="string">TCP</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">Service</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">error-code-svc</span> <span class="comment"># 当请求异常，接收到规定的错误码时，请求会重定向到这个service，用来处理错误请求，返回默认内容</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span>
      <span class="attr">targetPort:</span> <span class="number">80</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
  <span class="attr">selector:</span>
    <span class="attr">app:</span> <span class="string">error</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">apps/v1</span>
<span class="attr">kind:</span> <span class="string">Deployment</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">nginx-deploy</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">replicas:</span> <span class="number">2</span>
  <span class="attr">selector:</span>
    <span class="attr">matchLabels:</span>
      <span class="attr">app:</span> <span class="string">nginx</span>
  <span class="attr">template:</span>
    <span class="attr">metadata:</span>
      <span class="attr">labels:</span>
        <span class="attr">app:</span> <span class="string">nginx</span>
    <span class="attr">spec:</span>
      <span class="attr">containers:</span>
        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span>
          <span class="attr">image:</span> <span class="string">nginx:1.29.0</span>
          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>
          <span class="attr">ports:</span>
            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span>
              <span class="attr">containerPort:</span> <span class="number">80</span>
              <span class="attr">protocol:</span> <span class="string">TCP</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">Service</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">nginx-svc</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span>
      <span class="attr">targetPort:</span> <span class="number">80</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
  <span class="attr">selector:</span>
    <span class="attr">app:</span> <span class="string">nginx</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span> <span class="comment"># 指定 API 版本</span>
<span class="attr">kind:</span> <span class="string">Ingress</span> <span class="comment"># 指定资源类型为 Ingress，表示这是一个用于管理 HTTP/HTTPS 流量的 Kubernetes 资源</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">ingress-single-errorcode</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
  <span class="attr">annotations:</span>
    <span class="attr">nginx.ingress.kubernetes.io/default-backend:</span> <span class="string">&#x27;error-code-svc&#x27;</span> <span class="comment"># 指定请求异常时，重定向到哪个SVC处理</span>
    <span class="attr">nginx.ingress.kubernetes.io/custom-http-errors:</span> <span class="string">&quot;404,415&quot;</span> <span class="comment"># 哪些错误代理重定向到默认后端svc</span>
<span class="attr">spec:</span>
  <span class="attr">ingressClassName:</span> <span class="string">nginx</span> <span class="comment"># 指定此 Ingress 资源由名称为 nginx 的 IngressClass 处理，定义在 values.yaml 中 controller.ingressClassResource.name</span>
  <span class="attr">rules:</span> <span class="comment"># 定义了流量路由的规则，即如何根据域名（host）和路径（path）将请求转发到后端服务。</span>
    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">single.errorcode.com</span> <span class="comment"># 指定此规则适用于请求的 HTTP 主机头（Host Header）为 single.errorcode.com 的流量。</span>
      <span class="attr">http:</span> <span class="comment"># 定义了 HTTP 协议的路由规则</span>
        <span class="attr">paths:</span> <span class="comment"># 用于指定路径匹配规则</span>
          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span> <span class="comment"># 指定匹配的 URL 路径为 /，即根路径,这是最常见的路径，表示匹配所有以 / 开头的请求</span>
            <span class="attr">pathType:</span> <span class="string">Prefix</span> <span class="comment"># 定义路径匹配的类型为 Prefix，表示匹配以指定路径（/) 开头的所有请求</span>
            <span class="attr">backend:</span> <span class="comment"># 定义请求的转发目标，即后端服务</span>
              <span class="attr">service:</span>
                <span class="attr">name:</span> <span class="string">nginx-svc</span> <span class="comment"># 指定后端服务的名称为 nginx-svc.（必须存在于同一命名空间，或通过 &lt;namespace&gt;/&lt;service-name&gt; 跨命名空间引用）</span>
                <span class="attr">port:</span>
                  <span class="attr">number:</span> <span class="number">80</span> <span class="comment"># 指定目标 Service 的端口为 80</span></code></pre>



<p>为了体现出单独为 Ingress 声明错误码的处理效果，这里先将 ingress-nginx 的全局错误码处理关闭</p>
<pre><code class="highlight yaml"><span class="comment"># 修改 values.yaml</span>
<span class="attr">defaultBackend:</span>
  <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment"># 关闭全局错误码重定向</span>
  <span class="attr">name:</span> <span class="string">defaultbackend</span>
  <span class="attr">image:</span>
    <span class="attr">registry:</span> <span class="string">registry.k8s.io</span>
    <span class="attr">image:</span> <span class="string">defaultbackend-amd64</span>
    <span class="attr">tag:</span> <span class="string">&quot;1.5&quot;</span>
    <span class="attr">pullPolicy:</span> <span class="string">IfNotPresent</span>
    

<span class="comment"># 更新 Ingress Nginx</span>
<span class="string">$</span> <span class="string">helm</span> <span class="string">upgrade</span> <span class="string">ingress-nginx</span> <span class="string">.</span> <span class="string">-n</span> <span class="string">ingress-nginx</span></code></pre>



<blockquote>
<p>执行资源清单</p>
<pre><code class="highlight bash">$ kubectl apply -f ingress-nginx-single-errorcode.yaml</code></pre>
</blockquote>
<blockquote>
<p>修改主机host文件，添加域名映射</p>
<p>IP 可以是集群内部署了 Ingress-Controler 的任意一台服务器 IP</p>
<pre><code class="highlight plaintext">10.20.1.140 single.errorcode.com</code></pre>
</blockquote>
<p><strong>测试：</strong></p>
<p>使用浏览器访问一个不存在的路径，在没有错误码重定向时会返回 404， 如今为 Ingress 单独配置了错误码，会返回配置的 Service 的数据。</p>
<p><a target="_blank" rel="noopener" href="http://single.errorcode.com/api/index1.html">http://single.errorcode.com/api/index1.html</a></p>
<p><img src="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/07/04/20250704-153741.png" alt="自定义错误码返回"></p>
<h2 id="7-Ingress-nginx-匹配请求头"><a href="#7-Ingress-nginx-匹配请求头" class="headerlink" title="7. Ingress-nginx  匹配请求头"></a>7. Ingress-nginx  匹配请求头</h2><p>使用 ingress-nginx 实现根据不同的请求头，将请求转发到不同的服务。需要先开启 ingress-nginx 的 snippet 功能。</p>
<h3 id="7-1-开启-Snippet"><a href="#7-1-开启-Snippet" class="headerlink" title="7.1 开启 Snippet"></a>7.1 开启 Snippet</h3><pre><code class="highlight bash"><span class="comment"># 编辑 ingress-nginx-controller ConfigMap</span>
$ kubectl edit cm ingress-nginx-controller -n ingress-nginx

<span class="comment"># 开启 snippet</span>
apiVersion: v1
data:
  allow-snippet-annotations: <span class="string">&quot;true&quot;</span></code></pre>



<h3 id="7-2-编辑资源清单"><a href="#7-2-编辑资源清单" class="headerlink" title="7.2 编辑资源清单"></a>7.2 编辑资源清单</h3><p><code>ingress-nginx-match-request-header.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>
<span class="attr">kind:</span> <span class="string">Deployment</span>
<span class="attr">metadata:</span>
  <span class="attr">labels:</span>
    <span class="attr">app:</span> <span class="string">snippet</span>
  <span class="attr">name:</span> <span class="string">snippet-dep</span>
<span class="attr">spec:</span>
  <span class="attr">replicas:</span> <span class="number">1</span>
  <span class="attr">selector:</span>
    <span class="attr">matchLabels:</span>
      <span class="attr">app:</span> <span class="string">snippet</span>
  <span class="attr">template:</span>
    <span class="attr">metadata:</span>
      <span class="attr">labels:</span>
        <span class="attr">app:</span> <span class="string">snippet</span>
    <span class="attr">spec:</span>
      <span class="attr">containers:</span>
        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">snippet-deploy</span>
          <span class="attr">image:</span> <span class="string">nginx:1.29.0</span>
          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>
<span class="meta">---</span>
<span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">Service</span>
<span class="attr">metadata:</span>
  <span class="attr">labels:</span>
    <span class="attr">app:</span> <span class="string">snippet</span>
  <span class="attr">name:</span> <span class="string">snippet-svc</span>
<span class="attr">spec:</span>
  <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">80</span><span class="number">-80</span>
      <span class="attr">port:</span> <span class="number">80</span>
      <span class="attr">targetPort:</span> <span class="number">80</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
  <span class="attr">selector:</span>
    <span class="attr">app:</span> <span class="string">snippet</span>
  <span class="attr">type:</span> <span class="string">ClusterIP</span>
<span class="meta">---</span>
<span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span>
<span class="attr">kind:</span> <span class="string">Ingress</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">snippet-igs</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
  <span class="attr">annotations:</span>
    <span class="attr">nginx.ingress.kubernetes.io/server-snippet:</span> <span class="string">|</span>
<span class="string">      set $agentflag 0;</span>
<span class="string">      if ($http_user_agent ~* &quot;(Android|IPhone)&quot;) &#123; # 如果是Android或IPhone访问会重定向到 www.baidu.com 的新网站</span>
<span class="string">        set $agentflag 1;</span>
<span class="string">      &#125;</span>
<span class="string">      if ($agentflag = 1) &#123;</span>
<span class="string">        return 302 http://www.baidu.com;</span>
<span class="string">      &#125;</span>
<span class="string"></span><span class="attr">spec:</span>
  <span class="attr">rules:</span>
    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">snippet.request.com</span>
      <span class="attr">http:</span>
        <span class="attr">paths:</span>
          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span>
            <span class="attr">pathType:</span> <span class="string">Prefix</span> <span class="comment"># 定义路径匹配的类型为 Prefix，表示匹配以指定路径（/) 开头的所有请求</span>
            <span class="attr">backend:</span>
              <span class="attr">service:</span>
                <span class="attr">name:</span> <span class="string">snippet-svc</span>
                <span class="attr">port:</span>
                  <span class="attr">number:</span> <span class="number">80</span></code></pre>



<blockquote>
<p>执行资源清单</p>
<pre><code class="highlight bash">$ kubectl apply -f ingress-nginx-match-request-header.yaml</code></pre>
</blockquote>
<blockquote>
<p>编辑Host文件</p>
<pre><code class="highlight bash">$ <span class="built_in">cat</span> /etc/hosts
10.20.1.140 snippet.request.com</code></pre>

<p>10.20.1.140 是 node 节点，部署了 Ingress 控制器</p>
</blockquote>
<blockquote>
<p>测试访问：<strong>默认请求头</strong></p>
<pre><code class="highlight bash">$ curl http://snippet.request.com
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;<span class="built_in">head</span>&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;</code></pre>

<p>成功访问到 Nginx</p>
</blockquote>
<blockquote>
<p>测试访问：添加请求头</p>
<pre><code class="highlight bash">$ curl http://snippet.request.com -H <span class="string">&#x27;User-Agent: Android&#x27;</span>  -I
HTTP/1.1 302 Moved Temporarily
Date: Fri, 04 Jul 2025 07:08:56 GMT
Content-Type: text/html
Content-Length: 138
Connection: keep-alive
Location: http://www.baidu.com</code></pre>

<p>请求重定向到了 <a target="_blank" rel="noopener" href="http://www.baidu.com/">www.baidu.com</a></p>
</blockquote>
<h2 id="8-Ingress-nginx-配置黑白名单"><a href="#8-Ingress-nginx-配置黑白名单" class="headerlink" title="8. Ingress-nginx  配置黑白名单"></a>8. Ingress-nginx  配置黑白名单</h2><h3 id="8-1-配置方案"><a href="#8-1-配置方案" class="headerlink" title="8.1. 配置方案"></a>8.1. 配置方案</h3><p>Ingress-nginx 配置黑白名单有两种方式：</p>
<ul>
<li>Annotations：只对指定的ingress生效</li>
<li>ConfigMap：全局生效</li>
</ul>
<p>configmap官方配置文档说明：<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/</a></p>
<p><strong>若是同时配置了 Annotations 和 configmap，一般都是 annotations 生效，configmap 不生效，因为 annotations 优先级比 configmap 高</strong></p>
<h3 id="8-2-黑白名单的区别"><a href="#8-2-黑白名单的区别" class="headerlink" title="8.2 黑白名单的区别"></a>8.2 黑白名单的区别</h3><ul>
<li>白名单是默认是拒绝所有，只允许一个地址去访问</li>
<li>黑名单是不允许该地址去访问所有</li>
</ul>
<p>黑白名单配置使用 configmap 还是 annotations</p>
<ul>
<li>黑名单建议使用 ConfigMap 去配置</li>
<li>白名单建议使用 Annotations 去配置</li>
</ul>
<h3 id="8-3-ConfigMap-添加黑名单"><a href="#8-3-ConfigMap-添加黑名单" class="headerlink" title="8.3 ConfigMap 添加黑名单"></a>8.3 ConfigMap 添加黑名单</h3><p>配置黑名单禁止某一个或某一段 IP，需要在 Nginx Ingress 的 ConfigMap 中配置，比如将 10.20.1.141（多个配置逗号分隔）添加至黑名单。</p>
<p>configmap官方配置文档说明：<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/</a></p>
<h4 id="8-3-1-编辑-Ingress-Nginx-ConfigMap"><a href="#8-3-1-编辑-Ingress-Nginx-ConfigMap" class="headerlink" title="8.3.1 编辑 Ingress-Nginx ConfigMap"></a>8.3.1 编辑 Ingress-Nginx ConfigMap</h4><pre><code class="highlight bash">$ kubectl  edit cm ingress-nginx-controller -n ingress-nginx
apiVersion: v1
data:
  allow-snippet-annotations: <span class="string">&quot;true&quot;</span>
  block-cidrs: 10.20.1.141,10.20.1.149</code></pre>

<p>编辑后保存！</p>
<h4 id="8-3-2-测试资源清单"><a href="#8-3-2-测试资源清单" class="headerlink" title="8.3.2 测试资源清单"></a>8.3.2 测试资源清单</h4><p><code>ingress-nginx-black-block.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>
<span class="attr">kind:</span> <span class="string">Deployment</span>
<span class="attr">metadata:</span>
  <span class="attr">labels:</span>
    <span class="attr">app:</span> <span class="string">test</span>
  <span class="attr">name:</span> <span class="string">test-deploy</span>
<span class="attr">spec:</span>
  <span class="attr">replicas:</span> <span class="number">1</span>
  <span class="attr">selector:</span>
    <span class="attr">matchLabels:</span>
      <span class="attr">app:</span> <span class="string">test</span>
  <span class="attr">template:</span>
    <span class="attr">metadata:</span>
      <span class="attr">labels:</span>
        <span class="attr">app:</span> <span class="string">test</span>
    <span class="attr">spec:</span>
      <span class="attr">containers:</span>
        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.29.0</span>
          <span class="attr">name:</span> <span class="string">myapp</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">Service</span>
<span class="attr">metadata:</span>
  <span class="attr">labels:</span>
    <span class="attr">app:</span> <span class="string">test</span>
  <span class="attr">name:</span> <span class="string">test-svc</span>
<span class="attr">spec:</span>
  <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">80</span><span class="number">-80</span>
      <span class="attr">port:</span> <span class="number">80</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
      <span class="attr">targetPort:</span> <span class="number">80</span>
  <span class="attr">selector:</span>
    <span class="attr">app:</span> <span class="string">test</span>
  <span class="attr">type:</span> <span class="string">ClusterIP</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span>
<span class="attr">kind:</span> <span class="string">Ingress</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">global.black.com</span>
<span class="attr">spec:</span>
  <span class="attr">rules:</span>
    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">global.black.com</span>
      <span class="attr">http:</span>
        <span class="attr">paths:</span>
          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span>
            <span class="attr">pathType:</span> <span class="string">Prefix</span>
            <span class="attr">backend:</span>
              <span class="attr">service:</span>
                <span class="attr">name:</span> <span class="string">test-svc</span>
                <span class="attr">port:</span>
                  <span class="attr">number:</span> <span class="number">80</span></code></pre>



<p><strong>执行资源清单</strong></p>
<pre><code class="highlight bash">$ kubectl apply -f ingress-nginx-global-black.yaml</code></pre>



<p><strong>修改Host文件</strong></p>
<pre><code class="highlight bash"><span class="comment"># 在 10.20.1.140 服务器添加 Host 配置</span>
<span class="built_in">echo</span> <span class="string">&quot;10.20.1.140 global.black.com&quot;</span> &gt;&gt; /etc/hosts

<span class="comment"># 在 10.20.1.141 服务器添加 Host 配置</span>
<span class="built_in">echo</span> <span class="string">&quot;10.20.1.141 global.black.com&quot;</span> &gt;&gt; /etc/hosts</code></pre>



<p><strong>访问测试</strong></p>
<pre><code class="highlight bash"><span class="comment"># 在 10.20.1.140 服务器上测试，可以成功访问 Ingress</span>
$ curl global.block.com
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;<span class="built_in">head</span>&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;

<span class="comment"># 在 10.20.1.141 服务器上测试，访问被禁止，全局配置生效</span>
$ curl global.block.com
&lt;html&gt;
&lt;<span class="built_in">head</span>&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>





<h3 id="8-4-Annotations-添加黑名单"><a href="#8-4-Annotations-添加黑名单" class="headerlink" title="8.4 Annotations 添加黑名单"></a>8.4 Annotations 添加黑名单</h3><p><strong>资源清单：</strong> <code>ingress-nginx-annotations-black.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>
<span class="attr">kind:</span> <span class="string">Deployment</span>
<span class="attr">metadata:</span>
  <span class="attr">labels:</span>
    <span class="attr">app:</span> <span class="string">black</span>
  <span class="attr">name:</span> <span class="string">black-deploy</span>
<span class="attr">spec:</span>
  <span class="attr">replicas:</span> <span class="number">1</span>
  <span class="attr">selector:</span>
    <span class="attr">matchLabels:</span>
      <span class="attr">app:</span> <span class="string">black</span>
  <span class="attr">template:</span>
    <span class="attr">metadata:</span>
      <span class="attr">labels:</span>
        <span class="attr">app:</span> <span class="string">black</span>
    <span class="attr">spec:</span>
      <span class="attr">containers:</span>
        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.29.0</span>
          <span class="attr">name:</span> <span class="string">myapp</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">Service</span>
<span class="attr">metadata:</span>
  <span class="attr">labels:</span>
    <span class="attr">app:</span> <span class="string">black</span>
  <span class="attr">name:</span> <span class="string">black-svc</span>
<span class="attr">spec:</span>
  <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">80</span><span class="number">-80</span>
      <span class="attr">port:</span> <span class="number">80</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
      <span class="attr">targetPort:</span> <span class="number">80</span>
  <span class="attr">selector:</span>
    <span class="attr">app:</span> <span class="string">black</span>
  <span class="attr">type:</span> <span class="string">ClusterIP</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span>
<span class="attr">kind:</span> <span class="string">Ingress</span>
<span class="attr">metadata:</span>
  <span class="attr">annotations:</span>
    <span class="attr">nginx.ingress.kubernetes.io/server-snippet:</span> <span class="string">|</span>
<span class="string">      deny 10.20.1.141;       # 拒绝特定 IP</span>
<span class="string">      deny 192.168.6.0/24;    # 拒绝特定网段</span>
<span class="string">      allow all;              # 允许其他 IP</span>
<span class="string"></span>  <span class="attr">name:</span> <span class="string">annotaions.black.com</span>
<span class="attr">spec:</span>
  <span class="attr">rules:</span>
    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">annotaions.black.com</span>
      <span class="attr">http:</span>
        <span class="attr">paths:</span>
          <span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Prefix</span>
            <span class="attr">backend:</span>
              <span class="attr">service:</span>
                <span class="attr">name:</span> <span class="string">black-svc</span>
                <span class="attr">port:</span>
                  <span class="attr">number:</span> <span class="number">80</span>
            <span class="attr">path:</span> <span class="string">/</span></code></pre>



<p><strong>执行资源清单</strong></p>
<pre><code class="highlight bash">$ kubectl apply -f ingress-nginx-annotations-black.yaml</code></pre>



<p><strong>修改Host文件</strong></p>
<pre><code class="highlight bash"><span class="comment"># 在 10.20.1.140 服务器添加 Host 配置</span>
<span class="built_in">echo</span> <span class="string">&quot;10.20.1.140 annotaions.black.com&quot;</span> &gt;&gt; /etc/hosts

<span class="comment"># 在 10.20.1.141 服务器添加 Host 配置</span>
<span class="built_in">echo</span> <span class="string">&quot;10.20.1.141 annotaions.black.com&quot;</span> &gt;&gt; /etc/hosts</code></pre>



<p><strong>访问测试</strong></p>
<pre><code class="highlight bash"><span class="comment"># 在 10.20.1.140 服务器上测试，可以成功访问 Ingress</span>
$ curl annotaions.black.com
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;<span class="built_in">head</span>&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;

<span class="comment"># 在 10.20.1.141 服务器上测试，访问被禁止，全局配置生效</span>
$ curl annotaions.black.com
&lt;html&gt;
&lt;<span class="built_in">head</span>&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>





<h3 id="8-5-ConfigMap-设置白名单"><a href="#8-5-ConfigMap-设置白名单" class="headerlink" title="8.5 ConfigMap 设置白名单"></a>8.5 ConfigMap 设置白名单</h3><p>白名单表示只允许某个IP可以访问 </p>
<h4 id="8-5-1-编辑-Ingress-Nginx-ConfigMap"><a href="#8-5-1-编辑-Ingress-Nginx-ConfigMap" class="headerlink" title="8.5.1 编辑 Ingress-Nginx ConfigMap"></a>8.5.1 编辑 Ingress-Nginx ConfigMap</h4><p>添加 <code>whitelist-source-range</code> 配置</p>
<pre><code class="highlight bash">$ kubectl  edit cm ingress-nginx-controller -n ingress-nginx
apiVersion: v1
data:
  allow-snippet-annotations: <span class="string">&quot;true&quot;</span>
  block-cidrs: 10.20.1.141,10.20.1.149
  whitelist-source-range: 10.20.1.139,10.20.1.88</code></pre>

<p>编辑后保存！</p>
<h4 id="8-5-2-测试资源清单"><a href="#8-5-2-测试资源清单" class="headerlink" title="8.5.2 测试资源清单"></a>8.5.2 测试资源清单</h4><p><code>ingress-nginx-global-white.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>
<span class="attr">kind:</span> <span class="string">Deployment</span>
<span class="attr">metadata:</span>
  <span class="attr">labels:</span>
    <span class="attr">app:</span> <span class="string">test</span>
  <span class="attr">name:</span> <span class="string">test-deploy</span>
<span class="attr">spec:</span>
  <span class="attr">replicas:</span> <span class="number">1</span>
  <span class="attr">selector:</span>
    <span class="attr">matchLabels:</span>
      <span class="attr">app:</span> <span class="string">test</span>
  <span class="attr">template:</span>
    <span class="attr">metadata:</span>
      <span class="attr">labels:</span>
        <span class="attr">app:</span> <span class="string">test</span>
    <span class="attr">spec:</span>
      <span class="attr">containers:</span>
        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.29.0</span>
          <span class="attr">name:</span> <span class="string">myapp</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">Service</span>
<span class="attr">metadata:</span>
  <span class="attr">labels:</span>
    <span class="attr">app:</span> <span class="string">test</span>
  <span class="attr">name:</span> <span class="string">test-svc</span>
<span class="attr">spec:</span>
  <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">80</span><span class="number">-80</span>
      <span class="attr">port:</span> <span class="number">80</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
      <span class="attr">targetPort:</span> <span class="number">80</span>
  <span class="attr">selector:</span>
    <span class="attr">app:</span> <span class="string">test</span>
  <span class="attr">type:</span> <span class="string">ClusterIP</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span>
<span class="attr">kind:</span> <span class="string">Ingress</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">global.white.com</span>
<span class="attr">spec:</span>
  <span class="attr">rules:</span>
    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">global.white.com</span>
      <span class="attr">http:</span>
        <span class="attr">paths:</span>
          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span>
            <span class="attr">pathType:</span> <span class="string">Prefix</span>
            <span class="attr">backend:</span>
              <span class="attr">service:</span>
                <span class="attr">name:</span> <span class="string">test-svc</span>
                <span class="attr">port:</span>
                  <span class="attr">number:</span> <span class="number">80</span></code></pre>



<p><strong>执行资源清单</strong></p>
<pre><code class="highlight bash">$ kubectl apply -f ingress-nginx-global-white.yaml</code></pre>



<p><strong>修改Host文件</strong></p>
<pre><code class="highlight bash"><span class="comment"># 在 10.20.1.140 服务器添加 Host 配置</span>
<span class="built_in">echo</span> <span class="string">&quot;10.20.1.140 global.white.com&quot;</span> &gt;&gt; /etc/hosts

<span class="comment"># 在 10.20.1.139 服务器添加 Host 配置</span>
<span class="built_in">echo</span> <span class="string">&quot;10.20.1.140 global.white.com&quot;</span> &gt;&gt; /etc/hosts</code></pre>



<p><strong>访问测试</strong></p>
<pre><code class="highlight bash"><span class="comment"># 在 10.20.1.139 服务器上测试，可以成功访问 Ingress</span>
$ curl global.white.com
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;<span class="built_in">head</span>&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;

<span class="comment"># 在 10.20.1.140 服务器上测试，访问被禁止，全局配置生效</span>
$ curl global.white.com
&lt;html&gt;
&lt;<span class="built_in">head</span>&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>



<h3 id="8-6-Annotations-添加白名单"><a href="#8-6-Annotations-添加白名单" class="headerlink" title="8.6 Annotations 添加白名单"></a>8.6 Annotations 添加白名单</h3><p><strong>资源清单：</strong> <code>ingress-nginx-annotations-white.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>
<span class="attr">kind:</span> <span class="string">Deployment</span>
<span class="attr">metadata:</span>
  <span class="attr">labels:</span>
    <span class="attr">app:</span> <span class="string">white</span>
  <span class="attr">name:</span> <span class="string">white-deploy</span>
<span class="attr">spec:</span>
  <span class="attr">replicas:</span> <span class="number">1</span>
  <span class="attr">selector:</span>
    <span class="attr">matchLabels:</span>
      <span class="attr">app:</span> <span class="string">white</span>
  <span class="attr">template:</span>
    <span class="attr">metadata:</span>
      <span class="attr">labels:</span>
        <span class="attr">app:</span> <span class="string">white</span>
    <span class="attr">spec:</span>
      <span class="attr">containers:</span>
        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.29.0</span>
          <span class="attr">name:</span> <span class="string">myapp</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">Service</span>
<span class="attr">metadata:</span>
  <span class="attr">labels:</span>
    <span class="attr">app:</span> <span class="string">white</span>
  <span class="attr">name:</span> <span class="string">white-svc</span>
<span class="attr">spec:</span>
  <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">80</span><span class="number">-80</span>
      <span class="attr">port:</span> <span class="number">80</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
      <span class="attr">targetPort:</span> <span class="number">80</span>
  <span class="attr">selector:</span>
    <span class="attr">app:</span> <span class="string">white</span>
  <span class="attr">type:</span> <span class="string">ClusterIP</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span>
<span class="attr">kind:</span> <span class="string">Ingress</span>
<span class="attr">metadata:</span>
  <span class="attr">annotations:</span>
    <span class="attr">nginx.ingress.kubernetes.io/whitelist-source-range:</span> <span class="string">&quot;10.20.1.140&quot;</span>
  <span class="attr">name:</span> <span class="string">annotations.white.com</span>
<span class="attr">spec:</span>
  <span class="attr">rules:</span>
    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">annotations.white.com</span>
      <span class="attr">http:</span>
        <span class="attr">paths:</span>
          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span>
            <span class="attr">pathType:</span> <span class="string">Prefix</span>
            <span class="attr">backend:</span>
              <span class="attr">service:</span>
                <span class="attr">name:</span> <span class="string">white-svc</span>
                <span class="attr">port:</span>
                  <span class="attr">number:</span> <span class="number">80</span></code></pre>



<p><strong>执行资源清单</strong></p>
<pre><code class="highlight bash">$ kubectl apply -f ingress-nginx-annotations-white.yaml</code></pre>



<p><strong>修改Host文件</strong></p>
<pre><code class="highlight bash"><span class="comment"># 在 10.20.1.140 服务器添加 Host 配置</span>
<span class="built_in">echo</span> <span class="string">&quot;10.20.1.140 annotations.white.com&quot;</span> &gt;&gt; /etc/hosts

<span class="comment"># 在 10.20.1.141 服务器添加 Host 配置</span>
<span class="built_in">echo</span> <span class="string">&quot;10.20.1.141 annotations.white.com&quot;</span> &gt;&gt; /etc/hosts</code></pre>



<p><strong>访问测试</strong></p>
<pre><code class="highlight bash"><span class="comment"># 在 10.20.1.140 服务器上测试，可以成功访问 Ingress</span>
$ curl annotations.white.com
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;<span class="built_in">head</span>&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;

<span class="comment"># 在 10.20.1.141 服务器上测试，访问被禁止，全局配置生效</span>
$ curl annotations.white.com
&lt;html&gt;
&lt;<span class="built_in">head</span>&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>





<h2 id="9-Ingress-nginx-速率限制"><a href="#9-Ingress-nginx-速率限制" class="headerlink" title="9. Ingress-nginx  速率限制"></a>9. Ingress-nginx  速率限制</h2><p>有时候可能需要限制速率以降低后端压力，或者限制单个IP每秒的访问速率防止攻击。此时可以使用  Nginx 的 rate limit 进行配置</p>
<h3 id="9-1-速率限制设置"><a href="#9-1-速率限制设置" class="headerlink" title="9.1 速率限制设置"></a>9.1 速率限制设置</h3><pre><code class="highlight bash"><span class="comment">#限制每秒的连接，单个 IP： </span>
nginx.ingress.kubernetes.io/limit-rps

<span class="comment">#限制每分钟的连接，单个 IP： </span>
nginx.ingress.kubernetes.io/limit-rpm 

<span class="comment">#限制客户端每秒传输的字节数，单位为 K，需要开启 proxy-buffering： </span>
nginx.ingress.kubernetes.io/limit-rate 

<span class="comment">#速率限制白名单 </span>
nginx.ingress.kubernetes.io/limit-whitelist</code></pre>



<h3 id="9-2-测试案例：无速率限制"><a href="#9-2-测试案例：无速率限制" class="headerlink" title="9.2 测试案例：无速率限制"></a>9.2 测试案例：无速率限制</h3><p>资源清单 ：<code>ingress-nginx-rate-limit-pod.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>
<span class="attr">kind:</span> <span class="string">Deployment</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">speed-deploy</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">replicas:</span> <span class="number">2</span>
  <span class="attr">selector:</span>
    <span class="attr">matchLabels:</span>
      <span class="attr">app:</span> <span class="string">speed</span>
  <span class="attr">template:</span>
    <span class="attr">metadata:</span>
      <span class="attr">labels:</span>
        <span class="attr">app:</span> <span class="string">speed</span>
    <span class="attr">spec:</span>
      <span class="attr">containers:</span>
        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span>
          <span class="attr">image:</span> <span class="string">nginx:1.29.0</span>
          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>
<span class="meta">---</span>
<span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">Service</span>
<span class="attr">metadata:</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
  <span class="attr">name:</span> <span class="string">speed-svc</span>
<span class="attr">spec:</span>
  <span class="attr">selector:</span>
    <span class="attr">app:</span> <span class="string">speed</span>
  <span class="attr">type:</span> <span class="string">ClusterIP</span>
  <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">80</span><span class="number">-80</span>
      <span class="attr">port:</span> <span class="number">80</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
      <span class="attr">targetPort:</span> <span class="number">80</span></code></pre>



<p><strong>执行资源清单</strong></p>
<pre><code class="highlight bash">$ kubectl apply -f ingress-nginx-rate-limit-pod.yaml</code></pre>



<p><strong>编辑Host文件</strong></p>
<pre><code class="highlight bash"><span class="comment"># 在 10.20.1.140 服务器写入</span>
<span class="built_in">echo</span> <span class="string">&quot;10.20.1.140 rate.limit.com&quot;</span> &gt;&gt; /etc/hosts

<span class="comment"># 在 10.20.1.141 服务器写入</span>
<span class="built_in">echo</span> <span class="string">&quot;10.20.1.141 rate.limit.com&quot;</span> &gt;&gt; /etc/hosts</code></pre>



<p><strong>测试在无Ingress 限制速率的情况下， 发起100次请求</strong></p>
<pre><code class="highlight bash"><span class="comment"># 安装 ab 工具</span>
$ sudo yum install -y httpd-tools

<span class="comment"># 测试发起100个请求，并发数是 10</span>
$ ab -c 10 -n 100 http://rate.limit.com/ | grep requests
Complete requests:      100
Failed requests:        0
Time per request:       0.188 [ms] (mean, across all concurrent requests)
Percentage of the requests served within a certain time (ms)</code></pre>

<p>结论：在没有速率限制的情况下，100个请求全部成功。</p>
<h3 id="9-3-测试案例：使用-Ingress-限制请求速率"><a href="#9-3-测试案例：使用-Ingress-限制请求速率" class="headerlink" title="9.3 测试案例：使用 Ingress 限制请求速率"></a>9.3 测试案例：使用 Ingress 限制请求速率</h3><p>资源清单：<code>ingress-nginx-rate-limit-ingress.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span>
<span class="attr">kind:</span> <span class="string">Ingress</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">speed-ingress</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
  <span class="attr">annotations:</span>
    <span class="attr">nginx.ingress.kubernetes.io/limit-rps:</span> <span class="string">&quot;10&quot;</span>  <span class="comment"># 每秒最多 10 个请求</span>
    <span class="attr">nginx.ingress.kubernetes.io/limit-whitelist:</span> <span class="string">&quot;10.20.1.140,192.168.6.0/24&quot;</span>  <span class="comment"># 这些 IP 范围免于速率限制</span>
<span class="attr">spec:</span>
  <span class="attr">rules:</span>
    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">rate.limit.com</span>
      <span class="attr">http:</span>
        <span class="attr">paths:</span>
          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span>
            <span class="attr">pathType:</span> <span class="string">Prefix</span>
            <span class="attr">backend:</span>
              <span class="attr">service:</span>
                <span class="attr">name:</span> <span class="string">speed-svc</span>
                <span class="attr">port:</span>
                  <span class="attr">number:</span> <span class="number">80</span></code></pre>



<p><strong>执行资源清单</strong></p>
<pre><code class="highlight bash">$ kubectl apply -f ingress-nginx-rate-limit-ingress.yaml</code></pre>



<p><strong>测试速率限制</strong></p>
<pre><code class="highlight bash"><span class="comment"># 在 10.20.1.141 服务器上使用 ab 同时发起100个请求</span>
$ ab -c 10 -n 100 http://rate.limit.com/ | grep requests
Complete requests:      100
Failed requests:        49
Time per request:       0.205 [ms] (mean, across all concurrent requests)
Percentage of the requests served within a certain time (ms)
<span class="comment">###</span>
由于 Ingress 做了请求速率的限制，发起100个请求，有49个失败了
<span class="comment">###</span>


<span class="comment"># 在 10.20.1.140 服务器上使用 ab 同时发起100个请求</span>
$ ab -c 10 -n 100 http://rate.limit.com/ | grep requests
Complete requests:      100
Failed requests:        0
Time per request:       0.137 [ms] (mean, across all concurrent requests)
Percentage of the requests served within a certain time (ms)
<span class="comment">###</span>
虽然Ingress对请求做了速率限制，由于 10.20.1.140 服务器ip在ingress 速率限制的白名单中，因此请求速率不受限制，100个请求全部成功
<span class="comment">###</span></code></pre>





<h2 id="10-Ingress-nginx-灰度或者金丝雀发布"><a href="#10-Ingress-nginx-灰度或者金丝雀发布" class="headerlink" title="10. Ingress-nginx  灰度或者金丝雀发布"></a>10. Ingress-nginx  灰度或者金丝雀发布</h2><h3 id="10-1-概述"><a href="#10-1-概述" class="headerlink" title="10.1 概述"></a>10.1 概述</h3><p>灰度发布（也称金丝雀发布，Canary Release）是一种软件部署策略，旨在降低新版本上线带来的风险。它通过将新版本逐步推送给一小部分用户或系统（称为“金丝雀”），观察其表现、稳定性及用户反馈，再决定是否推广到全部用户。以下是详细解释：</p>
<p><strong>核心概念</strong></p>
<ol>
<li><strong>逐步推广</strong>：新版本不会一次性部署到所有用户，而是先部署到小规模用户群（如1%的用户或特定区域）。</li>
<li><strong>监控与验证</strong>：在灰度发布期间，开发团队会密切监控新版本的性能、错误率、用户体验等指标。</li>
<li><strong>快速回滚</strong>：如果发现问题，可以迅速回滚到旧版本，减少对用户的影响。</li>
<li><strong>金丝雀的由来</strong>：名称源于煤矿工人使用金丝雀鸟来检测矿井中有毒气体。如果鸟儿出现异常，工人会立即撤离。类似地，灰度发布通过小范围测试来“预警”潜在问题。</li>
</ol>
<p><strong>实施步骤</strong></p>
<ol>
<li><strong>选择目标群体</strong>：确定一小部分用户或服务器作为“金丝雀”，可以基于地理位置、用户ID、设备类型等条件。</li>
<li><strong>部署新版本</strong>：将新版本部署到选定群体，同时旧版本继续服务其他用户。</li>
<li><strong>监控表现</strong>：使用监控工具（如日志分析、性能指标、用户反馈）评估新版本的稳定性。</li>
<li><strong>逐步扩展</strong>：如果表现良好，逐步增加新版本的覆盖范围（如从1%到10%、50%直至100%）。</li>
<li><strong>回滚或全量发布</strong>：若发现问题，回滚到旧版本；若一切正常，完成全量发布。</li>
</ol>
<h3 id="10-2-创建-V1-版本的-Ingress"><a href="#10-2-创建-V1-版本的-Ingress" class="headerlink" title="10.2 创建  V1 版本的 Ingress"></a>10.2 创建  V1 版本的 Ingress</h3><p><strong>资源清单：</strong> <code>ingress-nginx-canary-release-v1.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>
<span class="attr">kind:</span> <span class="string">Deployment</span>
<span class="attr">metadata:</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
  <span class="attr">name:</span> <span class="string">canary-deploy-v1</span>
  <span class="attr">labels:</span>
    <span class="attr">app:</span> <span class="string">v1</span>
<span class="attr">spec:</span>
  <span class="attr">replicas:</span> <span class="number">10</span>
  <span class="attr">selector:</span>
    <span class="attr">matchLabels:</span>
      <span class="attr">app:</span> <span class="string">v1</span>
  <span class="attr">template:</span>
    <span class="attr">metadata:</span>
      <span class="attr">labels:</span>
        <span class="attr">app:</span> <span class="string">v1</span>
    <span class="attr">spec:</span>
      <span class="attr">containers:</span>
        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">deploy-v1</span>
          <span class="attr">image:</span> <span class="string">wangyanglinux/myapp:v1.0</span>
          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">Service</span>
<span class="attr">metadata:</span>
  <span class="attr">labels:</span>
    <span class="attr">app:</span> <span class="string">v1</span>
  <span class="attr">name:</span> <span class="string">canary-svc-v1</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">80</span><span class="number">-80</span>
      <span class="attr">port:</span> <span class="number">80</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
      <span class="attr">targetPort:</span> <span class="number">80</span>
  <span class="attr">selector:</span>
    <span class="attr">app:</span> <span class="string">v1</span>
  <span class="attr">type:</span> <span class="string">ClusterIP</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span>
<span class="attr">kind:</span> <span class="string">Ingress</span>
<span class="attr">metadata:</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
  <span class="attr">name:</span> <span class="string">ingress-v1</span>
  <span class="attr">annotations:</span>
    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span>
<span class="attr">spec:</span>
  <span class="attr">ingressClassName:</span> <span class="string">&quot;nginx&quot;</span>
  <span class="attr">rules:</span>
    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">canary.release.com</span>
      <span class="attr">http:</span>
        <span class="attr">paths:</span>
          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span>
            <span class="attr">pathType:</span> <span class="string">Prefix</span>
            <span class="attr">backend:</span>
              <span class="attr">service:</span>
                <span class="attr">name:</span> <span class="string">canary-svc-v1</span>
                <span class="attr">port:</span>
                  <span class="attr">number:</span> <span class="number">80</span></code></pre>



<p><strong>执行资源清单</strong></p>
<pre><code class="highlight bash">$ kubectl apply -f ingress-nginx-canary-release-v1.yaml</code></pre>



<p><strong>编辑Hosts文件</strong></p>
<pre><code class="highlight bash">$ <span class="built_in">echo</span> <span class="string">&quot;10.20.1.140 canary.release.com&quot;</span> &gt;&gt; /etc/hosts</code></pre>



<p><strong>测试请求</strong></p>
<pre><code class="highlight bash">$ curl http://canary.release.com
www.xinxianghf.com | hello MyAPP | version v1.0</code></pre>



<h3 id="10-3-创建-V2-版本的-Ingress"><a href="#10-3-创建-V2-版本的-Ingress" class="headerlink" title="10.3 创建 V2 版本的 Ingress"></a>10.3 创建 V2 版本的 Ingress</h3><p><strong>资源清单：</strong><code>ingress-nginx-canary-release-v2.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>
<span class="attr">kind:</span> <span class="string">Deployment</span>
<span class="attr">metadata:</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
  <span class="attr">name:</span> <span class="string">canary-deploy-v2</span>
  <span class="attr">labels:</span>
    <span class="attr">app:</span> <span class="string">v2</span>
<span class="attr">spec:</span>
  <span class="attr">replicas:</span> <span class="number">10</span>
  <span class="attr">selector:</span>
    <span class="attr">matchLabels:</span>
      <span class="attr">app:</span> <span class="string">v2</span>
  <span class="attr">template:</span>
    <span class="attr">metadata:</span>
      <span class="attr">labels:</span>
        <span class="attr">app:</span> <span class="string">v2</span>
    <span class="attr">spec:</span>
      <span class="attr">containers:</span>
        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">deploy-v2</span>
          <span class="attr">image:</span> <span class="string">wangyanglinux/myapp:v2.0</span>
          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">Service</span>
<span class="attr">metadata:</span>
  <span class="attr">labels:</span>
    <span class="attr">app:</span> <span class="string">v2</span>
  <span class="attr">name:</span> <span class="string">canary-svc-v2</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">80</span><span class="number">-80</span>
      <span class="attr">port:</span> <span class="number">80</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
      <span class="attr">targetPort:</span> <span class="number">80</span>
  <span class="attr">selector:</span>
    <span class="attr">app:</span> <span class="string">v2</span>
  <span class="attr">type:</span> <span class="string">ClusterIP</span>

<span class="meta">---</span>
<span class="meta"></span>
<span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span>
<span class="attr">kind:</span> <span class="string">Ingress</span>
<span class="attr">metadata:</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
  <span class="attr">name:</span> <span class="string">ingress-v2</span>
  <span class="attr">annotations:</span>
    <span class="attr">nginx.ingress.kubernetes.io/canary:</span> <span class="string">&quot;true&quot;</span> <span class="comment"># 启用金丝雀发布模式</span>
    <span class="attr">nginx.ingress.kubernetes.io/canary-weight:</span> <span class="string">&quot;10&quot;</span> <span class="comment"># 定义金丝雀服务的流量权重，单位为百分比</span>
<span class="attr">spec:</span>
  <span class="attr">ingressClassName:</span> <span class="string">&quot;nginx&quot;</span>
  <span class="attr">rules:</span>
    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">canary.release.com</span>
      <span class="attr">http:</span>
        <span class="attr">paths:</span>
          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span>
            <span class="attr">pathType:</span> <span class="string">Prefix</span>
            <span class="attr">backend:</span>
              <span class="attr">service:</span>
                <span class="attr">name:</span> <span class="string">canary-svc-v2</span>
                <span class="attr">port:</span>
                  <span class="attr">number:</span> <span class="number">80</span></code></pre>



<p><strong>执行资源清单</strong></p>
<pre><code class="highlight bash">$ kubectl apply -f ingress-nginx-canary-release-v2.yaml</code></pre>



<p><strong>编辑Hosts文件</strong></p>
<pre><code class="highlight bash">$ <span class="built_in">echo</span> <span class="string">&quot;10.20.1.140 canary.release.com&quot;</span> &gt;&gt; /etc/hosts</code></pre>



<p><strong>测试请求</strong></p>
<p>测试请求 100次， 查看请求汇总信息</p>
<pre><code class="highlight bash"><span class="comment"># 做100次请求</span>
$ <span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..100&#125;;<span class="keyword">do</span> curl http://canary.release.com  &gt;&gt; <span class="built_in">sum</span>;<span class="keyword">done</span>

<span class="comment"># 查看请求汇总信息</span>
$ <span class="built_in">cat</span> <span class="built_in">sum</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c
     92 www.xinxianghf.com | hello MyAPP | version v1.0
      8 www.xinxianghf.com | hello MyAPP | version v2.0</code></pre>

<p>结论：请求了100次，其中 92次请求到了 v1.0 版本， 8次请求到 v2.0版本。v2.0 大约占了 10%</p>
<h2 id="11-Ingress-nginx-代理后端-https-协议"><a href="#11-Ingress-nginx-代理后端-https-协议" class="headerlink" title="11. Ingress-nginx  代理后端 https 协议"></a>11. Ingress-nginx  代理后端 https 协议</h2><p>如果后端服务是 https 协议，需要使用 <code>nginx.ingress.kubernetes.io/backend-protocols</code> 声明后端服务是 <code>https</code> 。这里代理K8s的web控制台作为示例。代理后访问默认会强制跳转到 https 协议，返回的证书也是服务本身的证书。</p>
<p>资源清单：<code>ingress-nginx-proxy-https-pod.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>
<span class="attr">kind:</span> <span class="string">Deployment</span>
<span class="attr">metadata:</span>
  <span class="attr">labels:</span>
    <span class="attr">app:</span> <span class="string">proxyhttps</span>
  <span class="attr">name:</span> <span class="string">proxyhttps-deploy</span>
<span class="attr">spec:</span>
  <span class="attr">replicas:</span> <span class="number">1</span>
  <span class="attr">selector:</span>
    <span class="attr">matchLabels:</span>
      <span class="attr">app:</span> <span class="string">proxyhttps</span>
  <span class="attr">template:</span>
    <span class="attr">metadata:</span>
      <span class="attr">labels:</span>
        <span class="attr">app:</span> <span class="string">proxyhttps</span>
    <span class="attr">spec:</span>
      <span class="attr">containers:</span>
        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">wangyanglinux/tools:httpsv1</span>
          <span class="attr">name:</span> <span class="string">myapp</span>
<span class="meta">---</span>
<span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">Service</span>
<span class="attr">metadata:</span>
  <span class="attr">labels:</span>
    <span class="attr">app:</span> <span class="string">proxyhttps</span>
  <span class="attr">name:</span> <span class="string">proxyhttps-svc</span>
<span class="attr">spec:</span>
  <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">443</span><span class="number">-443</span>
      <span class="attr">port:</span> <span class="number">443</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
      <span class="attr">targetPort:</span> <span class="number">443</span>
  <span class="attr">selector:</span>
    <span class="attr">app:</span> <span class="string">proxyhttps</span>
  <span class="attr">type:</span> <span class="string">ClusterIP</span></code></pre>



<p><strong>执行资源清单</strong></p>
<pre><code class="highlight bash">$ kubectl apply -f ingress-nginx-proxy-https-pod.yaml</code></pre>



<p><strong>访问Service</strong></p>
<pre><code class="highlight bash"><span class="comment"># 查看 Service 资源</span>
$ kubectl get svc -o wide
NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE     SELECTOR
proxyhttps-svc   ClusterIP   10.103.15.21   &lt;none&gt;        443/TCP   3m25s   app=proxyhttps

<span class="comment"># 访问Service</span>
$ curl -k https://10.103.15.21
Hello, HTTPS!

$ curl http://10.103.15.21:443
Client sent an HTTP request to an HTTPS server.</code></pre>

<p>当前Service只能使用 HTTPS 访问</p>
<p><strong>只用 Ingress 代理后端 HTTPS 服务</strong></p>
<p>资源清单：<code>ingress-nginx-proxy-https-ingress.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span>
<span class="attr">kind:</span> <span class="string">Ingress</span>
<span class="attr">metadata:</span>
  <span class="attr">annotations:</span>
    <span class="attr">nginx.ingress.kubernetes.io/backend-protocol:</span> <span class="string">HTTPS</span>
  <span class="attr">name:</span> <span class="string">ingress.https.com</span>
  <span class="attr">namespace:</span> <span class="string">default</span>
<span class="attr">spec:</span>
  <span class="attr">rules:</span>
    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">ingress.https.com</span>
      <span class="attr">http:</span>
        <span class="attr">paths:</span>
          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span>
            <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span>
            <span class="attr">backend:</span>
              <span class="attr">service:</span>
                <span class="attr">name:</span> <span class="string">proxyhttps-svc</span>
                <span class="attr">port:</span>
                  <span class="attr">number:</span> <span class="number">443</span></code></pre>



<p><strong>执行资源清单</strong></p>
<pre><code class="highlight bash">$ kubectl apply -f ingress-nginx-proxy-https-ingress.yaml</code></pre>



<p><strong>编辑Host文件</strong></p>
<pre><code class="highlight bash">$ <span class="built_in">echo</span> <span class="string">&quot;10.20.1.140 ingress.https.com&quot;</span> &gt;&gt; /etc/hosts</code></pre>



<p><strong>请求测试</strong></p>
<pre><code class="highlight bash">$ curl http://ingress.https.com
Hello, HTTPS!</code></pre>

<p>结论：使用 Ingress 代理了后端HTTPS请求</p>
<h2 id="12-Ingress-nginx-四层代理"><a href="#12-Ingress-nginx-四层代理" class="headerlink" title="12. Ingress-nginx  四层代理"></a>12. Ingress-nginx  四层代理</h2><p>在新版本的nginx也引入了四层代理的概念，可直接代理TCP与UDP协议，在ingress-nginx也可以通过四层代理实现service的代理，实现方式如下：</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/exposing-tcp-udp-services/">https://kubernetes.github.io/ingress-nginx/user-guide/exposing-tcp-udp-services/</a></p>
<p>首先在使用 helm 部署 ingress-nginx 之后，需修改 nginx 启动资源的启动参数添加<code>--tcp-services-configmap</code>、<code>--udp-services-configmap</code> 的配置启用四层代理，通过修改配置 configmap 资源进行四层代理的配置。</p>
<h3 id="12-1TCP代理"><a href="#12-1TCP代理" class="headerlink" title="12.1TCP代理"></a>12.1TCP代理</h3><p><strong>修改 ingress-nginx 控制器</strong></p>
<p>在 ingress-nginx-controller 中添加 <code>--tcp-services-configmap</code> 启动参数</p>
<pre><code class="highlight bash">$ kubectl  edit ds -n ingress-nginx ingress-nginx-controller

    spec:
      containers:
      - args:
        - /nginx-ingress-controller
        - --tcp-services-configmap=$(POD_NAMESPACE)/nginx-ingress-tcp-configmap
        
<span class="comment">#参数说明如下</span>
--tcp-services-configmap=$(POD_NAMESPACE)/  这里为固定，表示tcp配置选择ingress-nginx安装的命名空间的configmap资源
nginx-ingress-tcp-configmap  为configmap资源的名称</code></pre>



<p><strong>编辑 ConfigMap</strong></p>
<p><code>nginx-ingress-tcp-configmap.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">ConfigMap</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">nginx-ingress-tcp-configmap</span>
  <span class="attr">namespace:</span> <span class="string">ingress-nginx</span> <span class="comment"># ingress-nginx 所在的命名空间</span>
<span class="attr">data:</span>
  <span class="attr">&quot;9000&quot;:</span> <span class="string">&quot;default/proxyhttps-svc:443&quot;</span></code></pre>

<pre><code class="highlight bash">$ kubectl apply -f nginx-ingress-tcp-configmap.yaml</code></pre>



<p><strong>Pod资源清单</strong></p>
<p><code>ingress-nginx-tcp-proxy-pod.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>
<span class="attr">kind:</span> <span class="string">Deployment</span>
<span class="attr">metadata:</span>
  <span class="attr">labels:</span>
    <span class="attr">app:</span> <span class="string">proxyhttps</span>
  <span class="attr">name:</span> <span class="string">proxyhttps-deploy</span>
<span class="attr">spec:</span>
  <span class="attr">replicas:</span> <span class="number">1</span>
  <span class="attr">selector:</span>
    <span class="attr">matchLabels:</span>
      <span class="attr">app:</span> <span class="string">proxyhttps</span>
  <span class="attr">template:</span>
    <span class="attr">metadata:</span>
      <span class="attr">labels:</span>
        <span class="attr">app:</span> <span class="string">proxyhttps</span>
    <span class="attr">spec:</span>
      <span class="attr">containers:</span>
        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">wangyanglinux/tools:httpsv1</span>
          <span class="attr">name:</span> <span class="string">myapp</span>
<span class="meta">---</span>
<span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">Service</span>
<span class="attr">metadata:</span>
  <span class="attr">labels:</span>
    <span class="attr">app:</span> <span class="string">proxyhttps</span>
  <span class="attr">name:</span> <span class="string">proxyhttps-svc</span>
<span class="attr">spec:</span>
  <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">443</span><span class="number">-443</span>
      <span class="attr">port:</span> <span class="number">443</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
      <span class="attr">targetPort:</span> <span class="number">443</span>
  <span class="attr">selector:</span>
    <span class="attr">app:</span> <span class="string">proxyhttps</span>
  <span class="attr">type:</span> <span class="string">ClusterIP</span></code></pre>



<p><strong>执行资源清单</strong></p>
<pre><code class="highlight bash">$ kubectl apply -f ingress-nginx-tcp-proxy-pod.yaml</code></pre>



<p><strong>测试四层代理访问</strong></p>
<pre><code class="highlight bash">$ kubectl get svc -o wide
NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE    SELECTOR
proxyhttps-svc   ClusterIP   10.96.172.123   &lt;none&gt;        443/TCP   63s    app=proxyhttps

<span class="comment"># 首先直接访问 SVC，确认服务可用</span>
$ curl -k https://10.96.172.123:443
Hello, HTTPS!

<span class="comment"># 测试通过ingress 4层代理访问</span>
$ curl -k https://10.20.1.140:9000
Hello, HTTPS!</code></pre>



<h3 id="12-2-UDP代理"><a href="#12-2-UDP代理" class="headerlink" title="12.2 UDP代理"></a>12.2 UDP代理</h3><p><strong>修改 ingress-nginx 控制器</strong></p>
<p>在 ingress-nginx-controller 中添加 <code>--tcp-services-configmap</code> 启动参数</p>
<pre><code class="highlight bash">$ kubectl  edit ds -n ingress-nginx ingress-nginx-controller

    spec:
      containers:
      - args:
        - /nginx-ingress-controller
        - --udp-services-configmap=$(POD_NAMESPACE)/nginx-ingress-udp-configmap
        
<span class="comment">#参数说明如下</span>
--tcp-services-configmap=$(POD_NAMESPACE)/  这里为固定，表示tcp配置选择ingress-nginx安装的命名空间的configmap资源
nginx-ingress-tcp-configmap  为configmap资源的名称</code></pre>



<p><strong>编辑 ConfigMap</strong></p>
<p><code>nginx-ingress-udp-configmap.yaml</code></p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">ConfigMap</span>
<span class="attr">metadata:</span>
  <span class="attr">name:</span> <span class="string">nginx-ingress-udp-configmap</span>
  <span class="attr">namespace:</span> <span class="string">ingress</span>
<span class="attr">data:</span>
  <span class="attr">&quot;53&quot;:</span> <span class="string">&quot;kube-system/kube-dns:53&quot;</span></code></pre>





<h2 id="13-Ingress-nginx-链路追踪"><a href="#13-Ingress-nginx-链路追踪" class="headerlink" title="13. Ingress-nginx  链路追踪"></a>13. Ingress-nginx  链路追踪</h2><p>官方文档：<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/third-party-addons/opentracing/#jaeger">https://kubernetes.github.io/ingress-nginx/user-guide/third-party-addons/opentracing/#jaeger</a></p>
<p>官方推荐的链路追踪插件为 Zipkin 或者 Jaeger。这里我们选用 Jaeger。</p>
<p>官方部署示例文件: <a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/jaegertracing/jaeger-kubernetes/master/all-in-one/jaeger-all-in-one-template.yml">https://raw.githubusercontent.com/jaegertracing/jaeger-kubernetes/master/all-in-one/jaeger-all-in-one-template.yml</a></p>
<h3 id="13-1-部署-Jaeger"><a href="#13-1-部署-Jaeger" class="headerlink" title="13.1 部署 Jaeger"></a>13.1 部署 Jaeger</h3><pre><code class="highlight bash"><span class="comment"># 下载部署资源清单</span>
wget https://raw.githubusercontent.com/jaegertracing/jaeger-kubernetes/master/all-in-one/jaeger-all-in-one-template.yml

</code></pre>

<p>修改 jaeger 资源清单</p>
<pre><code class="highlight yaml"><span class="attr">apiVersion:</span> <span class="string">v1</span>
<span class="attr">kind:</span> <span class="string">List</span>
<span class="attr">items:</span>
<span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">apps/v1</span> <span class="comment"># 将版本修改为 apps/v1</span>
  <span class="attr">kind:</span> <span class="string">Deployment</span>
  <span class="attr">metadata:</span>
    <span class="attr">name:</span> <span class="string">jaeger</span>
    <span class="attr">labels:</span>
      <span class="attr">app:</span> <span class="string">jaeger</span>
      <span class="attr">app.kubernetes.io/name:</span> <span class="string">jaeger</span>
      <span class="attr">app.kubernetes.io/component:</span> <span class="string">all-in-one</span>
  <span class="attr">spec:</span>
    <span class="attr">replicas:</span> <span class="number">1</span>
    <span class="attr">selector:</span> <span class="comment"># 添加选择器， apps/v1版本需要</span>
      <span class="attr">matchLabels:</span>
        <span class="attr">app:</span> <span class="string">jaeger</span>
    <span class="attr">strategy:</span>
      <span class="attr">type:</span> <span class="string">Recreate</span>
    <span class="attr">template:</span>
      <span class="attr">metadata:</span>
        <span class="attr">labels:</span>
          <span class="attr">app:</span> <span class="string">jaeger</span>
          <span class="attr">app.kubernetes.io/name:</span> <span class="string">jaeger</span>
          <span class="attr">app.kubernetes.io/component:</span> <span class="string">all-in-one</span>
        <span class="attr">annotations:</span>
          <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span>
          <span class="attr">prometheus.io/port:</span> <span class="string">&quot;16686&quot;</span>
      <span class="attr">spec:</span>
          <span class="attr">containers:</span>
          <span class="bullet">-</span>   <span class="attr">env:</span>
              <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">COLLECTOR_ZIPKIN_HTTP_PORT</span>
                <span class="attr">value:</span> <span class="string">&quot;9411&quot;</span>
              <span class="attr">image:</span> <span class="string">jaegertracing/all-in-one</span>
              <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span> <span class="comment"># 修改镜像下载策略，提前将镜像下载好</span>
              <span class="attr">name:</span> <span class="string">jaeger</span>
              <span class="attr">ports:</span>
                <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5775</span>
                  <span class="attr">protocol:</span> <span class="string">UDP</span>
                <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6831</span>
                  <span class="attr">protocol:</span> <span class="string">UDP</span>
                <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6832</span>
                  <span class="attr">protocol:</span> <span class="string">UDP</span>
                <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5778</span>
                  <span class="attr">protocol:</span> <span class="string">TCP</span>
                <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">16686</span>
                  <span class="attr">protocol:</span> <span class="string">TCP</span>
                <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9411</span>
                  <span class="attr">protocol:</span> <span class="string">TCP</span>
              <span class="attr">readinessProbe:</span>
                <span class="attr">httpGet:</span>
                  <span class="attr">path:</span> <span class="string">&quot;/&quot;</span>
                  <span class="attr">port:</span> <span class="number">14269</span>
                <span class="attr">initialDelaySeconds:</span> <span class="number">5</span>
<span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span>
  <span class="attr">kind:</span> <span class="string">Service</span>
  <span class="attr">metadata:</span>
    <span class="attr">name:</span> <span class="string">jaeger-query</span>
    <span class="attr">labels:</span>
      <span class="attr">app:</span> <span class="string">jaeger</span>
      <span class="attr">app.kubernetes.io/name:</span> <span class="string">jaeger</span>
      <span class="attr">app.kubernetes.io/component:</span> <span class="string">query</span>
  <span class="attr">spec:</span>
    <span class="attr">ports:</span>
      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">query-http</span>
        <span class="attr">port:</span> <span class="number">80</span>
        <span class="attr">protocol:</span> <span class="string">TCP</span>
        <span class="attr">targetPort:</span> <span class="number">16686</span>
    <span class="attr">selector:</span>
      <span class="attr">app.kubernetes.io/name:</span> <span class="string">jaeger</span>
      <span class="attr">app.kubernetes.io/component:</span> <span class="string">all-in-one</span>
    <span class="attr">type:</span> <span class="string">LoadBalancer</span>
<span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span>
  <span class="attr">kind:</span> <span class="string">Service</span>
  <span class="attr">metadata:</span>
    <span class="attr">name:</span> <span class="string">jaeger-collector</span>
    <span class="attr">labels:</span>
      <span class="attr">app:</span> <span class="string">jaeger</span>
      <span class="attr">app.kubernetes.io/name:</span> <span class="string">jaeger</span>
      <span class="attr">app.kubernetes.io/component:</span> <span class="string">collector</span>
  <span class="attr">spec:</span>
    <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jaeger-collector-tchannel</span>
      <span class="attr">port:</span> <span class="number">14267</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
      <span class="attr">targetPort:</span> <span class="number">14267</span>
    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jaeger-collector-http</span>
      <span class="attr">port:</span> <span class="number">14268</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
      <span class="attr">targetPort:</span> <span class="number">14268</span>
    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jaeger-collector-zipkin</span>
      <span class="attr">port:</span> <span class="number">9411</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
      <span class="attr">targetPort:</span> <span class="number">9411</span>
    <span class="attr">selector:</span>
      <span class="attr">app.kubernetes.io/name:</span> <span class="string">jaeger</span>
      <span class="attr">app.kubernetes.io/component:</span> <span class="string">all-in-one</span>
    <span class="attr">type:</span> <span class="string">ClusterIP</span>
<span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span>
  <span class="attr">kind:</span> <span class="string">Service</span>
  <span class="attr">metadata:</span>
    <span class="attr">name:</span> <span class="string">jaeger-agent</span>
    <span class="attr">labels:</span>
      <span class="attr">app:</span> <span class="string">jaeger</span>
      <span class="attr">app.kubernetes.io/name:</span> <span class="string">jaeger</span>
      <span class="attr">app.kubernetes.io/component:</span> <span class="string">agent</span>
  <span class="attr">spec:</span>
    <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">agent-zipkin-thrift</span>
      <span class="attr">port:</span> <span class="number">5775</span>
      <span class="attr">protocol:</span> <span class="string">UDP</span>
      <span class="attr">targetPort:</span> <span class="number">5775</span>
    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">agent-compact</span>
      <span class="attr">port:</span> <span class="number">6831</span>
      <span class="attr">protocol:</span> <span class="string">UDP</span>
      <span class="attr">targetPort:</span> <span class="number">6831</span>
    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">agent-binary</span>
      <span class="attr">port:</span> <span class="number">6832</span>
      <span class="attr">protocol:</span> <span class="string">UDP</span>
      <span class="attr">targetPort:</span> <span class="number">6832</span>
    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">agent-configs</span>
      <span class="attr">port:</span> <span class="number">5778</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
      <span class="attr">targetPort:</span> <span class="number">5778</span>
    <span class="attr">clusterIP:</span> <span class="string">None</span>
    <span class="attr">selector:</span>
      <span class="attr">app.kubernetes.io/name:</span> <span class="string">jaeger</span>
      <span class="attr">app.kubernetes.io/component:</span> <span class="string">all-in-one</span>
<span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span>
  <span class="attr">kind:</span> <span class="string">Service</span>
  <span class="attr">metadata:</span>
    <span class="attr">name:</span> <span class="string">zipkin</span>
    <span class="attr">labels:</span>
      <span class="attr">app:</span> <span class="string">jaeger</span>
      <span class="attr">app.kubernetes.io/name:</span> <span class="string">jaeger</span>
      <span class="attr">app.kubernetes.io/component:</span> <span class="string">zipkin</span>
  <span class="attr">spec:</span>
    <span class="attr">ports:</span>
    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jaeger-collector-zipkin</span>
      <span class="attr">port:</span> <span class="number">9411</span>
      <span class="attr">protocol:</span> <span class="string">TCP</span>
      <span class="attr">targetPort:</span> <span class="number">9411</span>
    <span class="attr">clusterIP:</span> <span class="string">None</span>
    <span class="attr">selector:</span>
      <span class="attr">app.kubernetes.io/name:</span> <span class="string">jaeger</span>
      <span class="attr">app.kubernetes.io/component:</span> <span class="string">all-in-one</span></code></pre>

<blockquote>
<p>可以将所有的 SVC、Deployment 都放到单独的命名空间中，这样就不会被误删除</p>
</blockquote>
<p><strong>执行 Jaeger 资源清单</strong></p>
<pre><code class="highlight bash">$ kubectl apply -f jaeger-all-in-one-template.yml 

<span class="comment"># 查看 SVC, !!! 注意：浏览器访问 jaeger 是通过 jaeger-query， 这里的 31272 就是对外暴露的端口</span>
$ kubectl get svc
NAME               TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                               AGE
jaeger-agent       ClusterIP      None            &lt;none&gt;        5775/UDP,6831/UDP,6832/UDP,5778/TCP   12m
jaeger-collector   ClusterIP      10.99.111.240   &lt;none&gt;        14267/TCP,14268/TCP,9411/TCP          12m
jaeger-query       LoadBalancer   10.100.53.251   &lt;pending&gt;     80:31272/TCP                          12m
kubernetes         ClusterIP      10.96.0.1       &lt;none&gt;        443/TCP                               4d5h
zipkin             ClusterIP      None            &lt;none&gt;        9411/TCP                              12m

<span class="comment"># 查看 Deployment</span>
$ kubectl get deploy
NAME     READY   UP-TO-DATE   AVAILABLE   AGE
jaeger   1/1     1            1           20s

<span class="comment"># 查看 Pod</span>
$ kubectl get pod
NAME                     READY   STATUS    RESTARTS   AGE
jaeger-cbfbf99b4-cxgq6   1/1     Running   0          22s</code></pre>

<p>到此 Jaeger 就部署好了</p>
<p><strong>注意：浏览器访问 jaeger 是通过 jaeger-query， 这里的 31272 就是对外暴露的端口，可以通过：http:&#x2F;&#x2F;物理机ip:31035 访问 Jaeger</strong></p>
<h3 id="13-2-ingress-设置"><a href="#13-2-ingress-设置" class="headerlink" title="13.2 ingress 设置"></a>13.2 ingress 设置</h3><p>需要修改 ingress 的 configmap 文件，添加相应参数，开启 Ingress 链路追踪</p>
<pre><code class="highlight bash">$ kubectl edit cm -n ingress-nginx ingress-nginx-controller

apiVersion: v1
data:
  allow-snippet-annotations: <span class="string">&quot;true&quot;</span>
  enable-opentracing: <span class="string">&quot;true&quot;</span>   <span class="comment">#开启链路追踪</span>
  jaeger-collector-host: jaeger-agent.default.svc.cluster.local  <span class="comment">#链路追踪的svc名称</span></code></pre>



<p><strong>重建 Ingress-Nginx Pod</strong></p>
<pre><code class="highlight bash"><span class="comment"># 查看Pod</span>
$ kubectl get pods -n ingress-nginx
NAME                             READY   STATUS    RESTARTS   AGE
ingress-nginx-controller-25wk6   1/1     Running   0          150m
ingress-nginx-controller-qcbp2   1/1     Running   0          151m

<span class="comment"># 删除Pod，等待重建</span>
$ kubectl delete pod ingress-nginx-controller-25wk6 ingress-nginx-controller-qcbp2 -n ingress-nginx</code></pre>



<p><strong>浏览器访问Jaeger</strong></p>
<p><a target="_blank" rel="noopener" href="http://10.20.1.139:31272/">http://10.20.1.139:31272/</a></p>
<p><img src="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/07/06/20250706-165831.png" alt="浏览器访问Jaeger"></p>
<p><img src="https://raw.githubusercontent.com/GeorgeChan95/blogimg/master/img/2025/07/06/20250706-170040.png" alt="查看请求"></p>
<p>参考链接</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://zhangzhuo.ltd/articles/2022/03/20/1647773666928.html">https://zhangzhuo.ltd/articles/2022/03/20/1647773666928.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tencent-cloud-native/p/13865502.html">https://www.cnblogs.com/tencent-cloud-native/p/13865502.html</a></p>
<p><a target="_blank" rel="noopener" href="https://k8s.whuanle.cn/4.network/3.ingress.html">https://k8s.whuanle.cn/4.network/3.ingress.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/linyb-geek/p/18153533">https://www.cnblogs.com/linyb-geek/p/18153533</a></p>
</blockquote>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 george_95@126.com </span>
    </div>
</article>





    <div id="comments"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

<script type="text/javascript">
    $.getScript('/js/gitalk.js', function () {
        var gitalk = new Gitalk({
            clientID: 'f820fe811764cacedc4f',
            clientSecret: '0ce07abb65f0e79ddb8830f32029b8a9656e0ee0',
            repo: 'georgechan95.github.io',
            owner: 'GeorgeChan95',
            admin: ['GeorgeChan95'],
            id: decodeURI(location.pathname),
            distractionFreeMode: 'true',
            language: 'zh-CN',
            perPage: parseInt('15',10)
        })
        gitalk.render('comments')
    })
</script>




    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    ©2016-2020 George
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    

    
    #post .pjax article :not(pre) > code {
        color: #24292e;
        font-family: SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;
        background-color: rgba(27,31,35,.05);
        border-radius: 3px;
        font-size: 85%;
        margin: 0;
        padding: .2em .4em;
    }
    
</style>







</html>
